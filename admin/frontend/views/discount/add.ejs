<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Discount - Bireena Bakery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="bi bi-percent"></i> Add New Discount</h4>
                    </div>
                    <div class="card-body">
                        <form action="/discount/add" method="POST">
                            <div class="mb-3">
                                <label class="form-label">Discount Name *</label>
                                <input type="text" class="form-control" name="name" required 
                                       placeholder="e.g., Weekend Sale, Festival Offer">
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Discount Type *</label>
                                    <select class="form-select" name="type" id="discountType" required>
                                        <option value="percentage">Percentage (%)</option>
                                        <option value="fixed">Fixed Amount (â‚¹)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Value *</label>
                                    <input type="number" class="form-control" name="value" id="discountValue" step="0.01" min="0.01" required>
                                    <small class="text-muted" id="valueHint"></small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Applicable On *</label>
                                    <select class="form-select" name="applicableOn" id="applicableOn" required>
                                        <option value="all">All Products</option>
                                        <option value="category">Specific Category</option>
                                        <option value="product">Specific Product</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3" id="categoryProductField" style="display: none;">
                                    <label class="form-label">Category/Product Name</label>
                                    <input type="text" class="form-control" name="categoryOrProduct" 
                                           placeholder="Enter category or product name">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" name="startDate" id="startDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Date *</label>
                                    <input type="date" class="form-control" name="endDate" id="endDate" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="sendSMS" name="sendSMS" onchange="toggleCustomerSelection()">
                                    <label class="form-check-label" for="sendSMS">
                                        <i class="bi bi-phone"></i> Send SMS to customers about this offer
                                    </label>
                                    <small class="d-block text-muted mt-1">
                                        ðŸ“± Select customers who will receive the offer notification
                                    </small>
                                </div>
                            </div>

                            <!-- Customer Selection -->
                            <div class="mb-3" id="customerSelectionDiv" style="display: none;">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>Select Customers</strong>
                                            <div>
                                                <button type="button" class="btn btn-sm btn-primary" onclick="selectAllCustomers()">
                                                    Select All
                                                </button>
                                                <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllCustomers()">
                                                    Deselect All
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                        <% if (customers && customers.length > 0) { %>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="radio" name="selectedCustomers" value="all" id="selectAllRadio" checked>
                                                <label class="form-check-label fw-bold" for="selectAllRadio">
                                                    ðŸ“¢ All Customers (<%= customers.length %> total)
                                                </label>
                                            </div>
                                            <hr>
                                            <small class="text-muted d-block mb-2">Or select specific customers:</small>
                                            <% customers.forEach(function(customer, index) { %>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input customer-checkbox" type="checkbox" 
                                                           name="selectedCustomers" value="<%= customer._id %>" 
                                                           id="customer<%= index %>"
                                                           onchange="handleCustomerCheckbox()">
                                                    <label class="form-check-label" for="customer<%= index %>">
                                                        <strong><%= customer.name || 'Walk-in Customer' %></strong>
                                                        <span class="badge bg-secondary ms-2"><%= customer._id %></span>
                                                        <br>
                                                        <small class="text-muted">
                                                            Purchases: <%= customer.totalPurchases %> | 
                                                            Last: <%= new Date(customer.lastPurchase).toLocaleDateString('en-IN') %>
                                                        </small>
                                                    </label>
                                                </div>
                                            <% }); %>
                                        <% } else { %>
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i> No customers with phone numbers found. 
                                                Phone numbers are saved during billing.
                                            </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="/discount" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle"></i> Add Discount
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const discountTypeSelect = document.getElementById('discountType');
        const discountValueInput = document.getElementById('discountValue');
        const valueHint = document.getElementById('valueHint');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        // Show/hide category/product field
        document.getElementById('applicableOn').addEventListener('change', function() {
            const field = document.getElementById('categoryProductField');
            if (this.value === 'all') {
                field.style.display = 'none';
            } else {
                field.style.display = 'block';
            }
        });
        
        // Percentage validation
        discountTypeSelect.addEventListener('change', updateValueHint);
        discountValueInput.addEventListener('input', function() {
            if (this.value < 0) this.value = 0;
            
            if (discountTypeSelect.value === 'percentage') {
                if (parseFloat(this.value) > 100) {
                    this.value = 100;
                    alert('Percentage discount cannot exceed 100%');
                }
            }
        });
        
        function updateValueHint() {
            if (discountTypeSelect.value === 'percentage') {
                valueHint.textContent = 'Maximum 100%';
                discountValueInput.max = 100;
            } else {
                valueHint.textContent = 'Amount in â‚¹';
                discountValueInput.removeAttribute('max');
            }
        }
        updateValueHint();
        
        // Date validation - end date must be after start date
        startDateInput.addEventListener('change', function() {
            endDateInput.min = this.value;
            if (endDateInput.value && new Date(endDateInput.value) < new Date(this.value)) {
                endDateInput.value = '';
                alert('End date must be after start date');
            }
        });
        
        endDateInput.addEventListener('change', function() {
            if (startDateInput.value && new Date(this.value) < new Date(startDateInput.value)) {
                alert('End date must be after start date!');
                this.value = '';
            }
        });
        
        // Customer selection functions
        function toggleCustomerSelection() {
            const checkbox = document.getElementById('sendSMS');
            const customerDiv = document.getElementById('customerSelectionDiv');
            customerDiv.style.display = checkbox.checked ? 'block' : 'none';
        }
        
        function selectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('selectAllRadio').checked = false;
        }
        
        function deselectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllRadio').checked = true;
        }
        
        function handleCustomerCheckbox() {
            const anyChecked = document.querySelectorAll('.customer-checkbox:checked').length > 0;
            if (anyChecked) {
                document.getElementById('selectAllRadio').checked = false;
            }
        }
    </script>
</body>
</html>
