<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Transfer - Bireena Bakery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show m-3">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>
    
    <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show m-3">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-arrow-left-right"></i> Stock Transfer</h2>
            <a href="/inventory" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Inventory
            </a>
        </div>

        <!-- Transfer Form -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">New Stock Transfer</h5>
            </div>
            <div class="card-body">
                <form action="/inventory/transfer" method="POST" id="transferForm">
                    <!-- Step 1: Select Source Employee FIRST -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><strong>1. Source Employee (From)</strong> *</label>
                            <select class="form-select" name="sourceEmployee" id="sourceEmployeeSelect" required>
                                <option value="">Select Source Employee (<%= employees.length %> available)</option>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>" data-name="<%= emp.fullName || emp.username %>">
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            </select>
                            <small class="text-muted">Select the employee to transfer stock FROM</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><strong>2. Product</strong> *</label>
                            <select name="productId" id="productSelect" class="form-select" required disabled>
                                <option value="">Total <%= products.length %> products in system - Select source employee first</option>
                            </select>
                            <small class="text-muted" id="productInfo">Products will load after selecting source employee</small>
                        </div>
                    </div>
                    
                    <!-- Step 2: Select Destination and Quantity -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><strong>3. Destination Employee (To)</strong> *</label>
                            <select class="form-select" name="destinationEmployee" id="destinationEmployeeSelect" required>
                                <option value="">Select Destination Employee</option>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>">
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            </select>
                            <small class="text-muted">Stock will be added to this employee</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><strong>4. Quantity</strong> *</label>
                            <input type="number" class="form-control" name="quantity" id="quantityInput" min="1" required disabled>
                            <small class="text-muted" id="stockInfo">Select product first</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Available Stock</label>
                            <input type="text" class="form-control" id="availableStock" readonly disabled style="background-color: #e9ecef;">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Transfer Notes</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Optional: Add notes about this transfer..."></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Transfer Process:</strong> Stock will be reduced from source employee and increased in destination employee immediately.
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                        <i class="bi bi-arrow-left-right"></i> Create Transfer
                    </button>
                </form>
            </div>
        </div>

        <!-- Transfer History -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Transfer History</h5>
            </div>
            <div class="card-body">
                <% if (transfers.length === 0) { %>
                    <p class="text-center text-muted py-5">No transfer history available.</p>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>DATE</th>
                                    <th>PRODUCT</th>
                                    <th>QUANTITY</th>
                                    <th>FROM → TO</th>
                                    <th>STATUS</th>
                                    <th>INITIATED BY</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% transfers.forEach(transfer => { %>
                                    <tr>
                                        <td><%= new Date(transfer.transferDate).toLocaleDateString() %></td>
                                        <td>
                                            <strong><%= transfer.productName %></strong>
                                        </td>
                                        <td><strong><%= transfer.quantity %></strong></td>
                                        <td>
                                            <%= transfer.sourceBranch %>
                                            <i class="bi bi-arrow-right"></i>
                                            <%= transfer.destinationBranch %>
                                        </td>
                                        <td>
                                            <% 
                                            let statusClass = 'bg-secondary';
                                            if (transfer.status === 'Completed') statusClass = 'bg-success';
                                            else if (transfer.status === 'Pending') statusClass = 'bg-warning';
                                            else if (transfer.status === 'In Transit') statusClass = 'bg-info';
                                            %>
                                            <span class="badge <%= statusClass %>"><%= transfer.status %></span>
                                        </td>
                                        <td>
                                            <% if (transfer.initiatedBy) { %>
                                                <%= transfer.initiatedBy.fullName || transfer.initiatedBy.username %>
                                            <% } else { %>
                                                <span class="text-muted">N/A</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Data for JavaScript -->
    <script id="products-data" type="application/json">
        <%- JSON.stringify(products) %>
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sourceEmployeeSelect = document.getElementById('sourceEmployeeSelect');
        const productSelect = document.getElementById('productSelect');
        const destinationEmployeeSelect = document.getElementById('destinationEmployeeSelect');
        const quantityInput = document.getElementById('quantityInput');
        const availableStockInput = document.getElementById('availableStock');
        const stockInfo = document.getElementById('stockInfo');
        const productInfo = document.getElementById('productInfo');
        const submitBtn = document.getElementById('submitBtn');
        const transferForm = document.getElementById('transferForm');
        
        // Load products data from JSON script tag
        const allProducts = JSON.parse(document.getElementById('products-data').textContent);
        let currentStock = 0;
        
        // Debug: Check products data
        console.log('All Products:', allProducts);
        console.log('Total Products:', allProducts.length);
        
        // Step 1: When source employee is selected, load products
        sourceEmployeeSelect.addEventListener('change', function() {
            const sourceEmployee = this.value;
            
            console.log('Selected Source Employee:', sourceEmployee);
            console.log('Selected Employee Name:', this.options[this.selectedIndex].dataset.name);
            
            // Clear previous selections
            productSelect.innerHTML = '<option value="">Select Product</option>';
            productSelect.disabled = true;
            quantityInput.disabled = true;
            quantityInput.value = '';
            availableStockInput.value = '';
            submitBtn.disabled = true;
            
            if (!sourceEmployee) {
                productInfo.textContent = 'Products will load after selecting source employee';
                productInfo.style.color = '';
                return;
            }
            
            // Filter products by source employee
            const employeeProducts = allProducts.filter(p => {
                console.log('Product:', p.name, 'addedBy:', p.addedBy);
                if (!p.addedBy) return false;
                
                // Handle both object and string cases
                const addedById = typeof p.addedBy === 'object' ? p.addedBy._id : p.addedBy;
                return addedById === sourceEmployee;
            });
            
            console.log('Filtered Products:', employeeProducts);
            console.log('Employee Products Count:', employeeProducts.length);
            
            if (employeeProducts.length === 0) {
                productInfo.textContent = '⚠️ No products available for this employee';
                productInfo.style.color = 'red';
                productSelect.disabled = true;
                return;
            }
            
            // Populate products dropdown
            employeeProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product._id;
                option.textContent = `${product.name} (Stock: ${product.stock} ${product.unit})`;
                option.dataset.stock = product.stock;
                option.dataset.unit = product.unit;
                option.dataset.name = product.name;
                productSelect.appendChild(option);
            });
            
            productSelect.disabled = false;
            productInfo.textContent = `✓ ${employeeProducts.length} product(s) available`;
            productInfo.style.color = 'green';
        });
        
        // Step 2: When product is selected, show stock info
        productSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            
            if (!this.value) {
                quantityInput.disabled = true;
                quantityInput.value = '';
                availableStockInput.value = '';
                currentStock = 0;
                stockInfo.textContent = 'Select product first';
                submitBtn.disabled = true;
                return;
            }
            
            currentStock = parseInt(selectedOption.dataset.stock) || 0;
            const unit = selectedOption.dataset.unit || 'unit';
            
            availableStockInput.value = `${currentStock} ${unit}`;
            quantityInput.max = currentStock;
            quantityInput.disabled = false;
            stockInfo.textContent = `Max: ${currentStock} ${unit}`;
            stockInfo.style.color = currentStock > 0 ? 'green' : 'red';
            
            if (currentStock === 0) {
                quantityInput.disabled = true;
                stockInfo.textContent = '⚠️ Out of stock!';
                submitBtn.disabled = true;
            } else {
                checkFormValidity();
            }
        });
        
        // Step 3: Validate quantity input
        quantityInput.addEventListener('input', function() {
            const quantity = parseInt(this.value) || 0;
            
            if (quantity > currentStock) {
                this.setCustomValidity(`Quantity cannot exceed ${currentStock}`);
                stockInfo.textContent = `❌ Too high! Max: ${currentStock}`;
                stockInfo.style.color = 'red';
                submitBtn.disabled = true;
            } else if (quantity < 1) {
                this.setCustomValidity('Quantity must be at least 1');
                stockInfo.textContent = '❌ Minimum quantity is 1';
                stockInfo.style.color = 'red';
                submitBtn.disabled = true;
            } else {
                this.setCustomValidity('');
                stockInfo.textContent = `✓ Valid quantity`;
                stockInfo.style.color = 'green';
                checkFormValidity();
            }
        });
        
        // Step 4: Check destination employee
        destinationEmployeeSelect.addEventListener('change', checkFormValidity);
        
        function checkFormValidity() {
            const sourceEmployee = sourceEmployeeSelect.value;
            const destEmployee = destinationEmployeeSelect.value;
            const product = productSelect.value;
            const quantity = parseInt(quantityInput.value) || 0;
            
            if (sourceEmployee && destEmployee && product && quantity > 0 && quantity <= currentStock && sourceEmployee !== destEmployee) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }
        
        // Form submission validation
        transferForm.addEventListener('submit', function(e) {
            const sourceEmployee = sourceEmployeeSelect.value;
            const destEmployee = destinationEmployeeSelect.value;
            const quantity = parseInt(quantityInput.value) || 0;
            const productName = productSelect.options[productSelect.selectedIndex].dataset.name;
            
            if (!sourceEmployee || !destEmployee || !productSelect.value) {
                e.preventDefault();
                alert('⚠️ Please fill in all required fields');
                return false;
            }
            
            if (sourceEmployee === destEmployee) {
                e.preventDefault();
                alert('⚠️ Source and Destination employees must be different!');
                return false;
            }
            
            if (quantity > currentStock) {
                e.preventDefault();
                alert(`⚠️ Insufficient stock! Available: ${currentStock}`);
                return false;
            }
            
            if (quantity < 1) {
                e.preventDefault();
                alert('⚠️ Quantity must be at least 1');
                return false;
            }
            
            // Confirmation dialog
            const sourceEmpName = sourceEmployeeSelect.options[sourceEmployeeSelect.selectedIndex].text;
            const destEmpName = destinationEmployeeSelect.options[destinationEmployeeSelect.selectedIndex].text;
            const confirmMsg = `Transfer ${quantity} units of "${productName}" from "${sourceEmpName}" to "${destEmpName}"?`;
            if (!confirm(confirmMsg)) {
                e.preventDefault();
                return false;
            }
            
            return true;
        });
    </script>
</body>
</html>
