<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - Bireena Bakery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Product</h4>
                    </div>
                    <div class="card-body">
                        <form action="/inventory/add" method="POST">
                            
                            <!-- ðŸ“¦ BASIC INFORMATION -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Product Name *</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Category *</label>
                                            <input type="text" class="form-control" name="category" list="categoryList" required>
                                            <datalist id="categoryList">
                                                <option value="Bread">
                                                <option value="Cake">
                                                <option value="Pastry">
                                                <option value="Cookie">
                                                <option value="Other">
                                            </datalist>
                                            <small class="text-muted">Type or select from suggestions</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ’° PRICING & PROFIT -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-currency-rupee"></i> Pricing & Profit</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Purchase Price (â‚¹) *</label>
                                            <input type="number" class="form-control" name="purchasePrice" id="purchasePrice" step="0.01" min="0.01" required>
                                            <small class="text-muted">Cost per unit</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Selling Price (â‚¹) *</label>
                                            <input type="number" class="form-control" name="sellingPrice" id="sellingPrice" step="0.01" min="0.01" required>
                                            <small class="text-muted">Retail price</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Profit Per Item</label>
                                            <div class="input-group">
                                                <span class="input-group-text">â‚¹</span>
                                                <input type="text" class="form-control" id="profitDisplay" readonly>
                                            </div>
                                            <small id="profitPercentage" class="text-success"></small>
                                        </div>
                                    </div>
                                    <!-- Hidden field for backward compatibility -->
                                    <input type="hidden" name="price" id="price">
                                </div>
                            </div>

                            <!-- ðŸ“Š STOCK DETAILS -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-box-seam"></i> Stock Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Initial Stock Quantity *</label>
                                            <input type="number" class="form-control" name="stock" min="0" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Unit *</label>
                                            <select class="form-select" name="unit" required>
                                                <option value="piece">Piece</option>
                                                <option value="kg">Kilogram (kg)</option>
                                                <option value="dozen">Dozen</option>
                                                <option value="box">Box</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Reorder Level</label>
                                            <input type="number" class="form-control" name="reorderLevel" value="10" min="0">
                                            <small class="text-muted">Low stock alert threshold</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ“… DATES & EXPIRY -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-calendar"></i> Dates & Expiry Tracking</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Manufacturing Date</label>
                                            <input type="date" class="form-control" name="mfgDate" id="mfgDate">
                                            <small class="text-muted">When product was made</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Expiry Date</label>
                                            <input type="date" class="form-control" name="expiryDate" id="expiryDate">
                                            <small class="text-muted">When product expires</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ¢ SUPPLIER DETAILS -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-truck"></i> Supplier / Vendor Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Supplier Name</label>
                                            <input type="text" class="form-control" name="supplierName">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Supplier Contact</label>
                                            <input type="tel" class="form-control" name="supplierContact" id="supplierContact" maxlength="10" pattern="[0-9]{10}" title="Please enter exactly 10 digits">
                                            <small class="text-muted">Optional (10 digits only)</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Last Purchased Date</label>
                                            <input type="date" class="form-control" name="lastPurchasedDate">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">HSN Code</label>
                                            <input type="text" class="form-control" name="hsnCode" maxlength="8" pattern="[0-9]{4,8}" placeholder="e.g., 1905">
                                            <small class="text-muted">Harmonized System of Nomenclature (4-8 digits)</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Batch Number</label>
                                            <input type="text" class="form-control" name="batchNumber">
                                            <small class="text-muted">For batch tracking</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ’° PAYMENT DETAILS -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-credit-card"></i> Payment Details for Supplier</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Total Purchase Amount (â‚¹)</label>
                                            <input type="number" class="form-control" name="totalPurchaseAmount" id="totalPurchaseAmount" min="0" step="0.01" placeholder="0.00">
                                            <small class="text-muted">Total amount to pay supplier</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Amount Paid Now (â‚¹)</label>
                                            <input type="number" class="form-control" name="amountPaid" id="amountPaid" min="0" step="0.01" placeholder="0.00">
                                            <small class="text-muted">Amount paying right now</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Amount Due (â‚¹)</label>
                                            <input type="number" class="form-control bg-light" name="amountDue" id="amountDue" readonly placeholder="0.00">
                                            <small class="text-muted">Auto-calculated</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Payment Method</label>
                                            <select class="form-select" name="paymentMethod" id="paymentMethod">
                                                <option value="none">No Payment Yet</option>
                                                <option value="cash">Cash</option>
                                                <option value="online">Online Transfer</option>
                                                <option value="upi">UPI</option>
                                                <option value="card">Card</option>
                                                <option value="mixed">Mixed (Cash + Online)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Payment Status</label>
                                            <input type="text" class="form-control bg-light" id="paymentStatus" readonly value="Not Specified">
                                            <small class="text-muted">Auto-calculated</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Payment Notes</label>
                                            <textarea class="form-control" name="paymentNotes" rows="2" placeholder="Additional payment notes (optional)"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ðŸ“ ADDITIONAL DETAILS -->
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-tag"></i> Additional Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Product Image</label>
                                            <input type="file" class="form-control" id="imageFile" accept="image/*">
                                            <small class="text-muted">Upload product image (max 5MB)</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">OR Image URL</label>
                                            <input type="url" class="form-control" name="image" id="imageUrl" placeholder="https://example.com/image.jpg">
                                            <small class="text-muted">Paste image URL or upload file above</small>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Image Preview</label>
                                        <div id="imagePreview" style="max-width: 200px; display: none;">
                                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="width: 100%;">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" name="description" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="/inventory" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Add Product
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Image preview for both URL and file upload
        const imageUrlInput = document.getElementById('imageUrl');
        const imageFileInput = document.getElementById('imageFile');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        // URL input preview
        imageUrlInput.addEventListener('input', function() {
            const url = this.value.trim();
            if (url) {
                imageFileInput.value = ''; // Clear file input
                previewImg.src = url;
                imagePreview.style.display = 'block';
                previewImg.onerror = function() {
                    imagePreview.style.display = 'none';
                };
            } else {
                if (!imageFileInput.value) {
                    imagePreview.style.display = 'none';
                }
            }
        });

        // File input preview
        imageFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB!');
                    this.value = '';
                    return;
                }

                // Check file type
                if (!file.type.match('image.*')) {
                    alert('Please select a valid image file!');
                    this.value = '';
                    return;
                }

                imageUrlInput.value = ''; // Clear URL input
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                    // Store base64 in hidden URL field for now
                    imageUrlInput.value = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                if (!imageUrlInput.value) {
                    imagePreview.style.display = 'none';
                }
            }
        });

        // Real-time profit calculation
        const purchaseInput = document.getElementById('purchasePrice');
        const sellingInput = document.getElementById('sellingPrice');
        const profitDisplay = document.getElementById('profitDisplay');
        const profitPercentage = document.getElementById('profitPercentage');
        const priceHidden = document.getElementById('price');

        function calculateProfit() {
            const purchase = parseFloat(purchaseInput.value) || 0;
            const selling = parseFloat(sellingInput.value) || 0;
            const profit = selling - purchase;
            const percentage = purchase > 0 ? ((profit / purchase) * 100).toFixed(1) : 0;

            profitDisplay.value = profit.toFixed(2);
            profitPercentage.textContent = `${percentage}% profit margin`;
            
            if (profit < 0) {
                profitDisplay.style.backgroundColor = '#ffebee';
                profitPercentage.style.color = 'red';
                profitPercentage.textContent = `${percentage}% LOSS!`;
            } else if (profit === 0) {
                profitDisplay.style.backgroundColor = '#fff3e0';
                profitPercentage.style.color = 'orange';
            } else {
                profitDisplay.style.backgroundColor = '#e8f5e9';
                profitPercentage.style.color = 'green';
            }

            // Set hidden price field to selling price for backward compatibility
            priceHidden.value = selling;
        }

        purchaseInput.addEventListener('input', calculateProfit);
        sellingInput.addEventListener('input', calculateProfit);

        // Prevent negative values in price inputs
        purchaseInput.addEventListener('input', function() {
            if (this.value < 0) this.value = 0;
        });
        
        sellingInput.addEventListener('input', function() {
            if (this.value < 0) this.value = 0;
        });

        // Auto-calculate expiry date based on MFG date (optional)
        const mfgInput = document.getElementById('mfgDate');
        const expiryInput = document.getElementById('expiryDate');
        
        // Set min expiry date when manufacturing date is selected
        mfgInput.addEventListener('change', function() {
            if (this.value) {
                // Set minimum expiry date to be after manufacturing date
                expiryInput.min = this.value;
                
                // Auto-suggest expiry date if not set
                if (!expiryInput.value) {
                    const mfgDate = new Date(this.value);
                    mfgDate.setDate(mfgDate.getDate() + 7); // Default 7 days shelf life
                    expiryInput.value = mfgDate.toISOString().split('T')[0];
                }
            }
        });
        
        // Validate expiry date is after manufacturing date
        expiryInput.addEventListener('change', function() {
            const mfgDate = mfgInput.value;
            const expDate = this.value;
            
            if (mfgDate && expDate && new Date(expDate) <= new Date(mfgDate)) {
                alert('Expiry date must be after Manufacturing date!');
                this.value = '';
            }
        });
        
        // Supplier contact validation
        const supplierContactInput = document.getElementById('supplierContact');
        if (supplierContactInput) {
            supplierContactInput.addEventListener('input', function() {
                // Remove non-numeric characters
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Limit to 10 digits
                if (this.value.length > 10) {
                    this.value = this.value.slice(0, 10);
                }
            });
            
            // Validate on form submit
            document.querySelector('form').addEventListener('submit', function(e) {
                const contact = supplierContactInput.value.trim();
                
                // If contact is entered, it must be exactly 10 digits
                if (contact !== '' && contact.length !== 10) {
                    e.preventDefault();
                    alert('Supplier contact must be exactly 10 digits or leave it empty!');
                    supplierContactInput.focus();
                    return false;
                }
            });
        }

        // ðŸ’° Auto-calculate payment details
        const totalPurchaseInput = document.getElementById('totalPurchaseAmount');
        const amountPaidInput = document.getElementById('amountPaid');
        const amountDueInput = document.getElementById('amountDue');
        const paymentMethodInput = document.getElementById('paymentMethod');
        const paymentStatusInput = document.getElementById('paymentStatus');

        function calculatePaymentDetails() {
            const totalPurchase = parseFloat(totalPurchaseInput.value) || 0;
            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const amountDue = totalPurchase - amountPaid;

            // Set amount due
            amountDueInput.value = amountDue.toFixed(2);

            // Determine payment status
            let status = 'Not Specified';
            if (totalPurchase > 0) {
                if (amountPaid === 0) {
                    status = 'Pending';
                } else if (amountDue <= 0) {
                    status = 'Fully Paid';
                } else {
                    status = 'Partial Payment';
                }
            }

            paymentStatusInput.value = status;

            // Color coding for amount due
            if (amountDue > 0) {
                amountDueInput.style.color = 'red';
                amountDueInput.style.fontWeight = 'bold';
            } else {
                amountDueInput.style.color = 'green';
                amountDueInput.style.fontWeight = 'bold';
            }
        }

        // Prevent negative values and over-payment
        amountPaidInput.addEventListener('input', function() {
            const totalPurchase = parseFloat(totalPurchaseInput.value) || 0;
            const amountPaid = parseFloat(this.value) || 0;

            if (amountPaid < 0) {
                this.value = 0;
            }
            
            // Warning if paying more than total purchase
            if (amountPaid > totalPurchase && totalPurchase > 0) {
                this.style.borderColor = 'orange';
            } else {
                this.style.borderColor = '';
            }

            calculatePaymentDetails();
        });

        totalPurchaseInput.addEventListener('input', function() {
            if (parseFloat(this.value) < 0) {
                this.value = 0;
            }
            calculatePaymentDetails();
        });

        // Auto-set payment method to "none" if amount paid is 0
        amountPaidInput.addEventListener('change', function() {
            const amountPaid = parseFloat(this.value) || 0;
            if (amountPaid === 0 && paymentMethodInput.value !== 'none') {
                if (confirm('Amount paid is 0. Set payment method to "No Payment Yet"?')) {
                    paymentMethodInput.value = 'none';
                }
            }
        });

        // Recalculate when payment method changes
        paymentMethodInput.addEventListener('change', calculatePaymentDetails);
    </script>
</body>
</html>
