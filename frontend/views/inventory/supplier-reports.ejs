<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Reports - <%= typeof user !== 'undefined' && user && user.shopName ? user.shopName : 'Bireena Bakery' %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .supplier-card {
            border-left: 4px solid #4F46E5;
            transition: all 0.3s;
            cursor: pointer;
        }
        .supplier-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .supplier-card.has-dues {
            border-left-color: #EF4444;
        }
        .supplier-card.selected {
            background: #EEF2FF;
            border-left-width: 6px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .product-tag {
            display: inline-block;
            padding: 4px 12px;
            background: #E0E7FF;
            border-radius: 20px;
            margin: 2px;
            font-size: 12px;
            color: #4F46E5;
        }
        .filter-badge {
            background: #4F46E5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-truck"></i> Supplier Reports</h2>
            <div>
                <button class="btn btn-info" onclick="exportSupplierReport()">
                    <i class="bi bi-download"></i> Export Report
                </button>
                <a href="/inventory" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Inventory
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="stat-card p-3">
                    <h5><i class="bi bi-truck"></i> <%= suppliers.length %></h5>
                    <small>Total Suppliers</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card success p-3">
                    <h5><i class="bi bi-box-seam"></i> <%= totalProducts %></h5>
                    <small>Products from Suppliers</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card warning p-3">
                    <h5>₹<%= totalValue.toFixed(2) %></h5>
                    <small>Total Stock Value</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card p-3">
                    <h5><i class="bi bi-graph-up"></i> <%= activeSuppliers %></h5>
                    <small>Active Suppliers</small>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-search"></i> Search Supplier
                        </label>
                        <input type="text" name="search" class="form-control" 
                               placeholder="Name or Contact..." 
                               value="<%= filters.search || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-filter"></i> Status
                        </label>
                        <select name="status" class="form-select" onchange="this.form.submit()">
                            <option value="">All Suppliers</option>
                            <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>Active (Has Stock)</option>
                            <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>Inactive (No Stock)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-sort-down"></i> Sort By
                        </label>
                        <select name="sortBy" class="form-select" onchange="this.form.submit()">
                            <option value="name" <%= filters.sortBy === 'name' ? 'selected' : '' %>>Name (A-Z)</option>
                            <option value="products" <%= filters.sortBy === 'products' ? 'selected' : '' %>>Product Count</option>
                            <option value="value" <%= filters.sortBy === 'value' ? 'selected' : '' %>>Stock Value</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">
                            <i class="bi bi-calendar"></i> Date Filter
                        </label>
                        <select name="dateFilter" class="form-select" onchange="this.form.submit()">
                            <option value="">All Time</option>
                            <option value="today" <%= filters.dateFilter === 'today' ? 'selected' : '' %>>Today</option>
                            <option value="week" <%= filters.dateFilter === 'week' ? 'selected' : '' %>>This Week</option>
                            <option value="month" <%= filters.dateFilter === 'month' ? 'selected' : '' %>>This Month</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <a href="/inventory/supplier-reports" class="btn btn-secondary flex-fill">
                            <i class="bi bi-x"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Suppliers Grid -->
        <div class="row">
            <% if (suppliers.length === 0) { %>
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle fs-1"></i>
                        <p class="mb-0 mt-2">No suppliers found with the current filters.</p>
                    </div>
                </div>
            <% } else { %>
                <% suppliers.forEach((supplier, index) => { %>
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card supplier-card <%= supplier.totalValue > 10000 ? 'has-dues' : '' %>" 
                             onclick="viewSupplierDetails('<%= supplier.name %>', '<%= supplier.contact %>')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h5 class="mb-1">
                                            <i class="bi bi-building"></i> 
                                            <%= supplier.name || 'Unknown Supplier' %>
                                        </h5>
                                        <small class="text-muted">
                                            <i class="bi bi-telephone"></i> 
                                            <%= supplier.contact || 'No Contact' %>
                                        </small>
                                    </div>
                                    <span class="badge <%= supplier.products.length > 0 ? 'bg-success' : 'bg-secondary' %>">
                                        <%= supplier.products.length > 0 ? 'Active' : 'Inactive' %>
                                    </span>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Products Supplied</small>
                                        <strong class="text-primary"><%= supplier.products.length %></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Total Stock</small>
                                        <strong><%= supplier.totalStock.toFixed(1) %> units</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Stock Value</small>
                                        <strong class="text-success">₹<%= supplier.totalValue.toFixed(2) %></strong>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted"><strong>Total Purchase</strong></small>
                                        <strong class="text-info">₹<%= (supplier.totalPurchaseAmount || 0).toFixed(2) %></strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <small class="text-muted">Amount Paid</small>
                                        <strong class="text-success">₹<%= (supplier.amountPaid || 0).toFixed(2) %></strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted"><strong>Amount Due</strong></small>
                                        <strong class="<%= (supplier.amountDue || 0) > 0 ? 'text-danger' : 'text-success' %>">₹<%= (supplier.amountDue || 0).toFixed(2) %></strong>
                                    </div>
                                </div>

                                <% if (supplier.products.length > 0) { %>
                                    <div class="border-top pt-2">
                                        <small class="text-muted d-block mb-1">Recent Products:</small>
                                        <div class="d-flex flex-wrap gap-1">
                                            <% supplier.products.slice(0, 3).forEach(product => { %>
                                                <span class="product-tag">
                                                    <%= product.name.substring(0, 15) %><%= product.name.length > 15 ? '...' : '' %>
                                                </span>
                                            <% }); %>
                                            <% if (supplier.products.length > 3) { %>
                                                <span class="product-tag">+<%= supplier.products.length - 3 %> more</span>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>

                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-sm btn-primary flex-fill" 
                                            onclick="event.stopPropagation(); viewSupplierDetails('<%= supplier.name %>', '<%= supplier.contact %>')">
                                        <i class="bi bi-eye"></i> View Details
                                    </button>
                                    <button class="btn btn-sm btn-info" 
                                            onclick="event.stopPropagation(); printSupplierReport('<%= supplier.name %>', '<%= supplier.contact %>')">
                                        <i class="bi bi-printer"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } %>
        </div>
    </div>

    <!-- Supplier Details Modal -->
    <div class="modal fade" id="supplierDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-building"></i> Supplier Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="supplierDetailsContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="makePaymentBtn" class="btn btn-success" onclick="showPaymentForm()" style="display:none;">
                        <i class="bi bi-cash-coin"></i> Make Payment
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printCurrentSupplier()">
                        <i class="bi bi-printer"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-cash-coin"></i> Make Payment to Supplier
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Supplier Name</label>
                            <input type="text" class="form-control bg-light" id="paymentSupplierName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Total Outstanding Dues</label>
                            <input type="text" class="form-control bg-light text-danger fw-bold" id="paymentTotalDue" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Payment Amount (₹) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="paymentAmount" min="0" step="0.01" placeholder="Enter amount to pay" required>
                            <small class="text-muted">Enter the amount you're paying now</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Payment Method <span class="text-danger">*</span></label>
                            <select class="form-select" id="paymentMethodSelect" required>
                                <option value="">-- Select Payment Method --</option>
                                <option value="cash">Cash</option>
                                <option value="online">Online Transfer</option>
                                <option value="upi">UPI</option>
                                <option value="card">Card</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Payment Notes</label>
                            <textarea class="form-control" id="paymentNotesInput" rows="3" placeholder="Add notes (optional): e.g., Transaction ID, Reference number, etc."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> <strong>Note:</strong> Payment will be distributed across products with outstanding dues.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="submitPayment()">
                        <i class="bi bi-check-circle"></i> Submit Payment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentSupplierName = '';
        let currentSupplierContact = '';

        function viewSupplierDetails(name, contact) {
            currentSupplierName = name;
            currentSupplierContact = contact;
            
            const modal = new bootstrap.Modal(document.getElementById('supplierDetailsModal'));
            modal.show();

            // Fetch supplier details
            fetch(`/inventory/supplier-details?name=${encodeURIComponent(name)}&contact=${encodeURIComponent(contact)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displaySupplierDetails(data.supplier);
                    } else {
                        document.getElementById('supplierDetailsContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> ${data.message || 'Failed to load supplier details'}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('supplierDetailsContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error loading supplier details
                        </div>
                    `;
                });
        }

        function displaySupplierDetails(supplier) {
            const html = `
                <!-- Supplier Header -->
                <div class="card mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-1"><i class="bi bi-building"></i> ${supplier.name || 'Unknown'}</h4>
                                <p class="mb-0"><i class="bi bi-telephone"></i> ${supplier.contact || 'No Contact'}</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <h5 class="mb-0">
                                    <span class="badge ${supplier.paymentStatus === 'Fully Paid' ? 'bg-success' : supplier.paymentStatus === 'Pending' ? 'bg-danger' : 'bg-warning'}">
                                        ${supplier.paymentStatus}
                                    </span>
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total Products</h6>
                                <h4 class="text-primary mb-0">${supplier.totalProducts}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Total Purchase</h6>
                                <h4 class="text-info mb-0">₹${supplier.totalPurchaseAmount.toFixed(2)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Amount Paid</h6>
                                <h4 class="text-success mb-0">₹${supplier.amountPaid.toFixed(2)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted mb-2">Amount Due</h6>
                                <h4 class="${supplier.amountDue > 0 ? 'text-danger' : 'text-success'} mb-0">₹${supplier.amountDue.toFixed(2)}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Table -->
                <h5 class="mb-3"><i class="bi bi-box-seam"></i> Products from this Supplier</h5>
                ${supplier.products.length === 0 ? 
                    '<div class="alert alert-info"><i class="bi bi-info-circle"></i> No products from this supplier</div>' :
                    `<div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                    <th>Purchase Price</th>
                                    <th>Selling Price</th>
                                    <th>Stock Value</th>
                                    <th>Purchase Amount</th>
                                    <th>Paid</th>
                                    <th>Due</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${supplier.products.map((product, index) => {
                                    const purchasePrice = product.purchasePrice || 0;
                                    const sellingPrice = product.sellingPrice || product.price || 0;
                                    const stock = product.stock || 0;
                                    const stockValue = stock * purchasePrice;
                                    const totalPurchase = product.totalPurchaseAmount || stockValue;
                                    const paid = product.amountPaid || 0;
                                    const due = totalPurchase - paid;
                                    
                                    return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${product.name}</strong>
                                            ${product.batchNumber ? `<br><small class="text-muted">Batch: ${product.batchNumber}</small>` : ''}
                                        </td>
                                        <td>${product.category || 'N/A'}</td>
                                        <td>${stock.toFixed(1)} ${product.unit || 'units'}</td>
                                        <td>₹${purchasePrice.toFixed(2)}</td>
                                        <td>₹${sellingPrice.toFixed(2)}</td>
                                        <td class="text-success"><strong>₹${stockValue.toFixed(2)}</strong></td>
                                        <td>₹${totalPurchase.toFixed(2)}</td>
                                        <td class="text-success">₹${paid.toFixed(2)}</td>
                                        <td class="${due > 0 ? 'text-danger' : 'text-success'}"><strong>₹${due.toFixed(2)}</strong></td>
                                        <td>
                                            <span class="badge ${stock > 10 ? 'bg-success' : stock > 0 ? 'bg-warning text-dark' : 'bg-danger'}">
                                                ${stock > 10 ? 'In Stock' : stock > 0 ? 'Low Stock' : 'Out of Stock'}
                                            </span>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="7" class="text-end">TOTAL:</th>
                                    <th>₹${supplier.totalPurchaseAmount.toFixed(2)}</th>
                                    <th class="text-success">₹${supplier.amountPaid.toFixed(2)}</th>
                                    <th class="${supplier.amountDue > 0 ? 'text-danger' : 'text-success'}">₹${supplier.amountDue.toFixed(2)}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>`
                }
            `;
            document.getElementById('supplierDetailsContent').innerHTML = html;
            
            // Show/hide Make Payment button based on dues
            const makePaymentBtn = document.getElementById('makePaymentBtn');
            if (supplier.amountDue > 0) {
                makePaymentBtn.style.display = 'inline-block';
            } else {
                makePaymentBtn.style.display = 'none';
            }
        }

        function showPaymentForm() {
            // Fetch latest supplier details
            fetch(`/inventory/supplier-details?name=${encodeURIComponent(currentSupplierName)}&contact=${encodeURIComponent(currentSupplierContact)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.supplier.amountDue > 0) {
                        // Populate payment form
                        document.getElementById('paymentSupplierName').value = data.supplier.name;
                        document.getElementById('paymentTotalDue').value = `₹${data.supplier.amountDue.toFixed(2)}`;
                        document.getElementById('paymentAmount').max = data.supplier.amountDue;
                        document.getElementById('paymentAmount').value = '';
                        document.getElementById('paymentMethodSelect').value = '';
                        document.getElementById('paymentNotesInput').value = '';
                        
                        // Show payment modal
                        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                        paymentModal.show();
                    } else {
                        alert('No outstanding dues found for this supplier.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading payment form');
                });
        }

        function submitPayment() {
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethodSelect').value;
            const paymentNotes = document.getElementById('paymentNotesInput').value;

            // Validation
            if (!paymentAmount || paymentAmount <= 0) {
                alert('Please enter a valid payment amount');
                return;
            }

            if (!paymentMethod) {
                alert('Please select a payment method');
                return;
            }

            // Confirm before submitting
            if (!confirm(`Confirm payment of ₹${paymentAmount.toFixed(2)} via ${paymentMethod.toUpperCase()} to ${currentSupplierName}?`)) {
                return;
            }

            // Submit payment
            fetch('/inventory/supplier-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    supplierName: currentSupplierName,
                    supplierContact: currentSupplierContact,
                    paymentAmount: paymentAmount,
                    paymentMethod: paymentMethod,
                    paymentNotes: paymentNotes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✓ ${data.message}\nRemaining Due: ₹${data.remainingDue}`);
                    
                    // Close payment modal
                    const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
                    paymentModal.hide();
                    
                    // Refresh supplier details
                    viewSupplierDetails(currentSupplierName, currentSupplierContact);
                    
                    // Reload page to update supplier list
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error processing payment');
            });
        }

        function printCurrentSupplier() {
            if (currentSupplierName) {
                printSupplierReport(currentSupplierName, currentSupplierContact);
            }
        }

        function printSupplierReport(name, contact) {
            // Open print window
            const url = `/inventory/supplier-report-print?name=${encodeURIComponent(name)}&contact=${encodeURIComponent(contact)}`;
            const printWindow = window.open(url, '_blank', 'width=800,height=600');
            if (printWindow) {
                setTimeout(() => {
                    printWindow.print();
                }, 1000);
            }
        }

        function exportSupplierReport() {
            const params = new URLSearchParams(window.location.search);
            window.location.href = '/inventory/supplier-export?' + params.toString();
        }

        // Auto-submit search on typing (debounced)
        let searchTimeout;
        document.querySelector('input[name="search"]').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                document.getElementById('filterForm').submit();
            }, 500);
        });
    </script>
</body>
</html>
