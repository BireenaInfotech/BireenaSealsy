<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Activity Log - Bireena Bakery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-clock-history"></i> Stock Activity Log</h2>
            <div class="d-flex gap-2">
                <button onclick="exportActivityCSV()" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel"></i> Export CSV
                </button>
                <a href="/inventory" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Inventory
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Product</label>
                        <select name="productId" class="form-select">
                            <option value="">All Products</option>
                            <% products.forEach(product => { %>
                                <option value="<%= product._id %>" <%= filters.productId === product._id.toString() ? 'selected' : '' %>>
                                    <%= product.name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Action</label>
                        <select name="action" class="form-select">
                            <option value="all">All Actions</option>
                            <option value="PRODUCT_ADDED" <%= filters.action === 'PRODUCT_ADDED' ? 'selected' : '' %>>Added</option>
                            <option value="PRODUCT_EDITED" <%= filters.action === 'PRODUCT_EDITED' ? 'selected' : '' %>>Edited</option>
                            <option value="STOCK_INCREASED" <%= filters.action === 'STOCK_INCREASED' ? 'selected' : '' %>>Stock Increased</option>
                            <option value="STOCK_DECREASED" <%= filters.action === 'STOCK_DECREASED' ? 'selected' : '' %>>Stock Decreased</option>
                            <option value="DAMAGE_ENTRY" <%= filters.action === 'DAMAGE_ENTRY' ? 'selected' : '' %>>Damage Entry</option>
                            <option value="STOCK_TRANSFER_OUT" <%= filters.action === 'STOCK_TRANSFER_OUT' ? 'selected' : '' %>>Transfer Out</option>
                            <option value="STOCK_TRANSFER_IN" <%= filters.action === 'STOCK_TRANSFER_IN' ? 'selected' : '' %>>Transfer In</option>
                            <option value="PRODUCT_DELETED" <%= filters.action === 'PRODUCT_DELETED' ? 'selected' : '' %>>Deleted</option>
                        </select>
                    </div>
                    <% if (typeof userRole !== 'undefined' && userRole === 'admin') { %>
                    <div class="col-md-2">
                        <label class="form-label">Employee</label>
                        <select name="employee" class="form-select">
                            <option value="">All Employees</option>
                            <% if (employees && employees.length > 0) { %>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>" <%= filters.employee === emp._id.toString() ? 'selected' : '' %>>
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <% } %>
                    <div class="col-md-2">
                        <label class="form-label">Start Date</label>
                        <input type="date" name="startDate" class="form-control" value="<%= filters.startDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">End Date</label>
                        <input type="date" name="endDate" class="form-control" value="<%= filters.endDate || '' %>">
                    </div>
                    <div class="col-12 d-flex justify-content-center gap-3 mt-3">
                        <button type="submit" class="btn btn-primary px-5">
                            <i class="bi bi-funnel"></i> APPLY
                        </button>
                        <a href="/inventory/activity-log" class="btn btn-secondary px-5">
                            <i class="bi bi-x-circle"></i> CLEAR
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="card">
            <div class="card-body">
                <% if (activities.length === 0) { %>
                    <p class="text-center text-muted py-5">No activity found.</p>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>TIMESTAMP</th>
                                    <th>PRODUCT</th>
                                    <% if (typeof user !== 'undefined' && user.role === 'admin') { %>
                                    <th>BRANCH</th>
                                    <% } %>
                                    <th>ACTION</th>
                                    <th>CHANGES</th>
                                    <th>PERFORMED BY</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% activities.forEach(activity => { %>
                                    <tr>
                                        <td>
                                            <%= new Date(activity.createdAt).toLocaleString() %>
                                        </td>
                                        <td><strong><%= activity.productName %></strong></td>
                                        <% if (typeof user !== 'undefined' && user.role === 'admin') { %>
                                        <td>
                                            <% 
                                            // Determine branch based on performer
                                            let displayBranch = 'N/A';
                                            if (activity.performedBy) {
                                                if (activity.performedBy.role === 'admin') {
                                                    displayBranch = 'ADMIN';
                                                } else if (activity.performedBy.branch) {
                                                    displayBranch = activity.performedBy.branch;
                                                }
                                            } else if (activity.branch) {
                                                displayBranch = activity.branch;
                                            }
                                            %>
                                            <%= displayBranch %>
                                        </td>
                                        <% } %>
                                        <td>
                                            <% 
                                            let badgeClass = 'bg-secondary';
                                            if (activity.action === 'PRODUCT_ADDED') badgeClass = 'bg-success';
                                            else if (activity.action === 'PRODUCT_EDITED') badgeClass = 'bg-primary';
                                            else if (activity.action === 'DAMAGE_ENTRY') badgeClass = 'bg-warning';
                                            else if (activity.action === 'STOCK_TRANSFER_OUT') badgeClass = 'bg-danger';
                                            else if (activity.action === 'STOCK_TRANSFER_IN') badgeClass = 'bg-info';
                                            else if (activity.action === 'PRODUCT_DELETED') badgeClass = 'bg-danger';
                                            %>
                                            <span class="badge <%= badgeClass %>">
                                                <%= activity.action.replace(/_/g, ' ') %>
                                            </span>
                                        </td>
                                        <td>
                                            <% if (activity.action === 'PRODUCT_EDITED' && activity.oldValue && activity.newValue) { %>
                                                <small>
                                                    Stock: <%= activity.oldValue.stock %> â†’ <%= activity.newValue.stock %>
                                                    <% if (activity.quantityChanged !== 0) { %>
                                                        <span class="<%= activity.quantityChanged > 0 ? 'text-success' : 'text-danger' %>">
                                                            (<%= activity.quantityChanged > 0 ? '+' : '' %><%= activity.quantityChanged %>)
                                                        </span>
                                                    <% } %>
                                                    <% if (activity.batchNumber) { %>
                                                        <br><i class="bi bi-upc-scan"></i> <strong>Batch:</strong> <%= activity.batchNumber %>
                                                    <% } %>
                                                </small>
                                            <% } else if (activity.action === 'DAMAGE_ENTRY') { %>
                                                <small class="text-danger">
                                                    -<%= Math.abs(activity.quantityChanged) %> units
                                                    <% if (activity.reason) { %>
                                                        <br><%= activity.reason %>
                                                    <% } %>
                                                </small>
                                            <% } else if (activity.action === 'STOCK_TRANSFER_OUT') { %>
                                                <small class="text-danger">
                                                    <i class="bi bi-arrow-right"></i> <strong>Transferred Out:</strong> <%= Math.abs(activity.quantityChanged) %> units
                                                    <% if (activity.transferSourceEmployeeName && activity.transferDestinationEmployeeName) { %>
                                                        <br><i class="bi bi-person-dash text-danger"></i> <strong>From:</strong> <%= activity.transferSourceEmployeeName %>
                                                        <br><i class="bi bi-arrow-right text-primary"></i> <strong>To:</strong> <%= activity.transferDestinationEmployeeName %>
                                                    <% } else if (activity.reason) { %>
                                                        <br><i class="bi bi-info-circle"></i> <%= activity.reason %>
                                                    <% } %>
                                                </small>
                                            <% } else if (activity.action === 'STOCK_TRANSFER_IN') { %>
                                                <small class="text-success">
                                                    <i class="bi bi-arrow-left"></i> <strong>Transferred In:</strong> <%= activity.quantityChanged %> units
                                                    <% if (activity.transferSourceEmployeeName && activity.transferDestinationEmployeeName) { %>
                                                        <br><i class="bi bi-person-dash text-danger"></i> <strong>From:</strong> <%= activity.transferSourceEmployeeName %>
                                                        <br><i class="bi bi-arrow-right text-success"></i> <strong>To:</strong> <%= activity.transferDestinationEmployeeName %>
                                                    <% } else if (activity.reason) { %>
                                                        <br><i class="bi bi-info-circle"></i> <%= activity.reason %>
                                                    <% } %>
                                                </small>
                                            <% } else if (activity.action === 'PRODUCT_ADDED') { %>
                                                <small class="text-success">
                                                    Initial stock: <%= activity.newValue ? activity.newValue.stock : activity.quantityChanged %>
                                                    <% if (activity.batchNumber) { %>
                                                        <br><i class="bi bi-upc-scan"></i> <strong>Batch:</strong> <%= activity.batchNumber %>
                                                    <% } %>
                                                    <% if (activity.supplierName) { %>
                                                        <br><i class="bi bi-person-badge"></i> Supplier: <%= activity.supplierName %>
                                                        <% if (activity.supplierContact) { %>
                                                            <br><i class="bi bi-telephone"></i> Contact: <%= activity.supplierContact %>
                                                        <% } %>
                                                    <% } %>
                                                </small>
                                            <% } %>
                                        </td>
                                        <td><%= activity.performedByName %></td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function exportActivityCSV() {
            // Get current filter values
            const productId = document.querySelector('[name="productId"]').value;
            const action = document.querySelector('[name="action"]').value;
            const startDate = document.querySelector('[name="startDate"]').value;
            const endDate = document.querySelector('[name="endDate"]').value;
            const employeeSelect = document.querySelector('[name="employee"]');
            const employee = employeeSelect ? employeeSelect.value : '';
            
            // Build query string
            const params = new URLSearchParams();
            if (productId) params.append('productId', productId);
            if (action && action !== 'all') params.append('action', action);
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            if (employee) params.append('employee', employee);
            
            // Redirect to export URL
            window.location.href = `/inventory/activity-log/export-csv?${params.toString()}`;
        }
    </script>
</body>
</html>
