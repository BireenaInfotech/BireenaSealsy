<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Report - Bireena Bakery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .report-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .report-tab {
            padding: 0.75rem 2rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .report-tab:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .report-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        .tab-content-section {
            display: none;
        }
        
        .tab-content-section.active {
            display: block;
        }
        
        .summary-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        .summary-card.green {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        
        .summary-card.red {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .summary-card.blue {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }
        
        .summary-card.orange {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        
        .icon-box {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
        
        .icon-box.green {
            background: rgba(16, 185, 129, 0.2);
            color: #059669;
        }
        
        .icon-box.red {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }
        
        .icon-box.blue {
            background: rgba(59, 130, 246, 0.2);
            color: #2563eb;
        }
        
        .icon-box.orange {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
            color: white;
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show m-3">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="container-fluid mt-4">
        <div class="page-header mb-4 d-flex justify-content-between align-items-center">
            <h2 style="color: #2563eb; font-weight: 700;">
                <i class="bi bi-clipboard-data"></i> Cashier Report
            </h2>
            <div class="d-flex gap-2">
                <a href="/gst-reports" class="btn btn-info" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);">
                    <i class="bi bi-file-earmark-text"></i> GST Reports
                </a>
                <a href="/expenses" class="btn btn-danger" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="bi bi-receipt"></i> Expenses
                </a>
            </div>
        </div>

        <!-- Report Tabs -->
        <div class="report-tabs">
            <div class="report-tab active" data-tab="summary">
                <i class="bi bi-pie-chart"></i> Summary
            </div>
            <div class="report-tab" data-tab="trends">
                <i class="bi bi-graph-up-arrow"></i> Trends
            </div>
            <div class="report-tab" data-tab="transactions">
                <i class="bi bi-list-ul"></i> Transactions
            </div>
        </div>

        <!-- ========== SUMMARY TAB ========== -->
        <div class="tab-content-section active" id="summary-tab">
            <!-- Date Filter -->
            <div class="filter-section">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="summaryStartDate" value="<%= filters.startDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="summaryEndDate" value="<%= filters.endDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Employee</label>
                        <select class="form-select" id="summaryEmployee">
                            <option value="">All Employees</option>
                            <% if (employees && employees.length > 0) { %>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>" <%= filters.employee === emp._id.toString() ? 'selected' : '' %>>
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Payment Status</label>
                        <select class="form-select" id="summaryPaymentStatus">
                            <option value="">All Payments</option>
                            <option value="paid" <%= filters.paymentStatus === 'paid' ? 'selected' : '' %>>Paid Only</option>
                            <option value="partial" <%= filters.paymentStatus === 'partial' ? 'selected' : '' %>>Partial Only</option>
                            <option value="due" <%= filters.paymentStatus === 'due' ? 'selected' : '' %>>Due Only</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applySummaryFilter()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="export-btn w-100" onclick="exportSummaryCSV()">
                            <i class="bi bi-file-earmark-excel"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="card summary-card green">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted mb-2 fw-bold">Total Collection</h6>
                                <h2 class="mb-1 fw-bold" style="color: #059669;">₹<%= stats.totalPaid.toFixed(2) %></h2>
                                <small class="text-muted">Total Payments Received</small>
                                <p class="mb-0 mt-2"><strong><%= sales.filter(s => !s.isCancelled).length %> payments</strong></p>
                            </div>
                            <div class="icon-box green">
                                <i class="bi bi-currency-rupee"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card summary-card red">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted mb-2 fw-bold">Total Refunds</h6>
                                <h2 class="mb-1 fw-bold" style="color: #dc2626;">₹<%= sales.filter(s => s.isCancelled).reduce((sum, s) => sum + s.refundAmount, 0).toFixed(2) %></h2>
                                <small class="text-muted">Total Refunds Processed</small>
                                <p class="mb-0 mt-2"><strong><%= sales.filter(s => s.isCancelled).length %> refunds</strong></p>
                            </div>
                            <div class="icon-box red">
                                <i class="bi bi-arrow-repeat"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card summary-card blue">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted mb-2 fw-bold">Net Collection</h6>
                                <h2 class="mb-1 fw-bold" style="color: #2563eb;">₹<%= (stats.totalPaid - sales.filter(s => s.isCancelled).reduce((sum, s) => sum + s.refundAmount, 0)).toFixed(2) %></h2>
                                <small class="text-muted">Collection - Refunds</small>
                                <p class="mb-0 mt-2"><strong><%= sales.length %> total transactions</strong></p>
                            </div>
                            <div class="icon-box blue">
                                <i class="bi bi-calculator"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card summary-card orange">
                        <div class="card-body d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="text-muted mb-2 fw-bold">Total Dues</h6>
                                <h2 class="mb-1 fw-bold" style="color: #f59e0b;">₹<%= stats.totalDue.toFixed(2) %></h2>
                                <small class="text-muted">Pending Payments</small>
                                <p class="mb-0 mt-2"><strong><%= sales.filter(s => !s.isCancelled && s.dueAmount > 0).length %> pending bills</strong></p>
                            </div>
                            <div class="icon-box orange">
                                <i class="bi bi-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transaction Summary -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold">Transaction Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card border" style="background: #f8f9fa;">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Total Transactions</h6>
                                    <h2 class="mb-0 fw-bold"><%= sales.length %></h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border" style="background: #d1fae5;">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Payment Transactions</h6>
                                    <h2 class="mb-0 fw-bold" style="color: #059669;"><%= sales.filter(s => !s.isCancelled).length %></h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border" style="background: #fee2e2;">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Refund Transactions</h6>
                                    <h2 class="mb-0 fw-bold" style="color: #dc2626;"><%= sales.filter(s => s.isCancelled).length %></h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Methods Breakdown -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0 fw-bold">Payment Methods Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <% 
                        // Calculate payment methods
                        const paymentMethods = {
                            cash: 0,
                            card: 0,
                            upi: 0,
                            bank: 0,
                            others: 0
                        };
                        const refundMethods = {
                            cash: 0,
                            card: 0,
                            upi: 0,
                            bank: 0,
                            others: 0
                        };
                        
                        sales.forEach(sale => {
                            const method = sale.paymentMethod.toLowerCase();
                            if (sale.isCancelled) {
                                if (method === 'cash') refundMethods.cash += sale.refundAmount;
                                else if (method === 'card') refundMethods.card += sale.refundAmount;
                                else if (method === 'upi') refundMethods.upi += sale.refundAmount;
                                else if (method === 'bank') refundMethods.bank += sale.refundAmount;
                                else refundMethods.others += sale.refundAmount;
                            } else {
                                if (method === 'cash') paymentMethods.cash += sale.amountPaid;
                                else if (method === 'card') paymentMethods.card += sale.amountPaid;
                                else if (method === 'upi') paymentMethods.upi += sale.amountPaid;
                                else if (method === 'bank') paymentMethods.bank += sale.amountPaid;
                                else paymentMethods.others += sale.amountPaid;
                            }
                        });
                        %>
                        
                        <!-- Payments Received -->
                        <div class="col-md-6">
                            <div class="card" style="background: #d1fae5; border-left: 4px solid #10b981;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: #059669;">Payments Received</h6>
                                    <div class="d-flex flex-column gap-3">
                                        <% Object.entries(paymentMethods).forEach(([method, amount]) => { 
                                            if (amount > 0) { %>
                                            <div class="card border-0" style="background: white;">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="text-uppercase fw-bold"><%= method %></span>
                                                        <span class="fs-4 fw-bold" style="color: #059669;">₹<%= amount.toFixed(2) %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } }); %>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Refunds Given -->
                        <div class="col-md-6">
                            <div class="card" style="background: #fee2e2; border-left: 4px solid #ef4444;">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3" style="color: #dc2626;">Refunds Given</h6>
                                    <div class="d-flex flex-column gap-3">
                                        <% Object.entries(refundMethods).forEach(([method, amount]) => { 
                                            if (amount > 0) { %>
                                            <div class="card border-0" style="background: white;">
                                                <div class="card-body p-3">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="text-uppercase fw-bold"><%= method %></span>
                                                        <span class="fs-4 fw-bold" style="color: #dc2626;">₹<%= amount.toFixed(2) %></span>
                                                    </div>
                                                </div>
                                            </div>
                                        <% } }); %>
                                        
                                        <% if (Object.values(refundMethods).every(v => v === 0)) { %>
                                            <p class="text-center text-muted mb-0">No refunds processed</p>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales History Table -->
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cart-check"></i> Sales History</h5>
                    <input type="text" id="salesSearch" class="form-control" placeholder="Search by Bill #..." style="max-width: 250px;">
                </div>
                <div class="card-body">
                    <% if (sales.length === 0) { %>
                        <p class="text-center text-muted">No sales found for the selected period</p>
                    <% } else { %>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Bill #</th>
                                        <th>Date & Time</th>
                                        <th>Customer</th>
                                        <th>Employee</th>
                                        <th>Items</th>
                                        <th>Subtotal</th>
                                        <th>Discount</th>
                                        <th>Total</th>
                                        <th>Paid</th>
                                        <th>Due</th>
                                        <th>Refund</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTableBody">
                                    <% sales.forEach(sale => { %>
                                        <tr>
                                            <td><strong>#<%= sale.billNumber.replace(/Bill-/i, '') %></strong></td>
                                            <td><%= new Date(sale.createdAt).toLocaleString() %></td>
                                            <td><%= sale.customerName || 'Walk-in' %></td>
                                            <td>
                                                <% if (sale.createdBy) { %>
                                                    <%= sale.createdBy.fullName || sale.createdBy.username %>
                                                <% } else { %>
                                                    Unknown
                                                <% } %>
                                            </td>
                                            <td><%= sale.items ? sale.items.length : 0 %></td>
                                            <td>₹<%= sale.subtotal.toFixed(2) %></td>
                                            <td class="text-success">
                                                <% if (sale.discount > 0) { %>
                                                    -₹<%= sale.discount.toFixed(2) %>
                                                <% } else { %>
                                                    ₹0.00
                                                <% } %>
                                            </td>
                                            <td><strong>₹<%= sale.total.toFixed(2) %></strong></td>
                                            <td class="text-success fw-bold">₹<%= sale.amountPaid.toFixed(2) %></td>
                                            <td class="<%= sale.dueAmount > 0 ? 'text-danger fw-bold' : '' %>">
                                                ₹<%= sale.dueAmount.toFixed(2) %>
                                            </td>
                                            <td>
                                                <% if (sale.isCancelled) { %>
                                                    <span class="text-danger fw-bold">₹<%= sale.refundAmount.toFixed(2) %></span>
                                                <% } else { %>
                                                    -
                                                <% } %>
                                            </td>
                                            <td><span class="badge bg-secondary"><%= sale.paymentMethod.toUpperCase() %></span></td>
                                            <td>
                                                <% if (sale.isCancelled) { %>
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-x-circle"></i> Cancelled
                                                    </span>
                                                <% } else if (sale.paymentStatus === 'paid') { %>
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> Paid
                                                    </span>
                                                <% } else if (sale.paymentStatus === 'partial') { %>
                                                    <span class="badge bg-warning">
                                                        <i class="bi bi-exclamation-circle"></i> Partial
                                                    </span>
                                                <% } else { %>
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-x-circle"></i> Due
                                                    </span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <a href="/bill/<%= sale._id %>" class="btn btn-sm btn-info" target="_blank">
                                                    <i class="bi bi-receipt"></i> View
                                                </a>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ========== TRENDS TAB ========== -->
        <div class="tab-content-section" id="trends-tab">
            <!-- Date Filter -->
            <div class="filter-section">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="trendsStartDate" value="<%= filters.startDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="trendsEndDate" value="<%= filters.endDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Employee</label>
                        <select class="form-select" id="trendsEmployee">
                            <option value="">All Employees</option>
                            <% if (employees && employees.length > 0) { %>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>" <%= filters.employee === emp._id.toString() ? 'selected' : '' %>>
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Payment Status</label>
                        <select class="form-select" id="trendsPaymentStatus">
                            <option value="">All Payments</option>
                            <option value="paid" <%= filters.paymentStatus === 'paid' ? 'selected' : '' %>>Paid Only</option>
                            <option value="partial" <%= filters.paymentStatus === 'partial' ? 'selected' : '' %>>Partial Only</option>
                            <option value="due" <%= filters.paymentStatus === 'due' ? 'selected' : '' %>>Due Only</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyTrendsFilter()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="export-btn w-100" onclick="exportTrendsCSV()">
                            <i class="bi bi-file-earmark-excel"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Trends Table -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Daily Trends</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="trendsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Total Payments</th>
                                    <th>Total Refunds</th>
                                    <th>Net Collection</th>
                                    <th>Total Dues</th>
                                    <th>Cash Payments</th>
                                    <th>Card Payments</th>
                                    <th>UPI Payments</th>
                                    <th>Bank Transfer</th>
                                    <th>Others</th>
                                    <th>Cash Refunds</th>
                                    <th>Card Refunds</th>
                                    <th>UPI Refunds</th>
                                    <th>Bank Refunds</th>
                                    <th>Others Refunds</th>
                                    <th>Transactions</th>
                                </tr>
                            </thead>
                            <tbody id="trendsTableBody">
                                <% 
                                // Group sales by date
                                const salesByDate = {};
                                sales.forEach(sale => {
                                    const date = new Date(sale.createdAt).toLocaleDateString();
                                    if (!salesByDate[date]) {
                                        salesByDate[date] = {
                                            payments: 0,
                                            refunds: 0,
                                            dues: 0,
                                            cash: 0,
                                            card: 0,
                                            upi: 0,
                                            bank: 0,
                                            others: 0,
                                            cashRefunds: 0,
                                            cardRefunds: 0,
                                            upiRefunds: 0,
                                            bankRefunds: 0,
                                            othersRefunds: 0,
                                            transactions: 0
                                        };
                                    }
                                    
                                    salesByDate[date].transactions++;
                                    
                                    if (sale.isCancelled) {
                                        salesByDate[date].refunds += sale.refundAmount;
                                        const method = sale.paymentMethod.toLowerCase();
                                        if (method === 'cash') salesByDate[date].cashRefunds += sale.refundAmount;
                                        else if (method === 'card') salesByDate[date].cardRefunds += sale.refundAmount;
                                        else if (method === 'upi') salesByDate[date].upiRefunds += sale.refundAmount;
                                        else if (method === 'bank') salesByDate[date].bankRefunds += sale.refundAmount;
                                        else salesByDate[date].othersRefunds += sale.refundAmount;
                                    } else {
                                        salesByDate[date].payments += sale.amountPaid;
                                        salesByDate[date].dues += sale.dueAmount;
                                        const method = sale.paymentMethod.toLowerCase();
                                        if (method === 'cash') salesByDate[date].cash += sale.amountPaid;
                                        else if (method === 'card') salesByDate[date].card += sale.amountPaid;
                                        else if (method === 'upi') salesByDate[date].upi += sale.amountPaid;
                                        else if (method === 'bank') salesByDate[date].bank += sale.amountPaid;
                                        else salesByDate[date].others += sale.amountPaid;
                                    }
                                });
                                
                                // Sort dates
                                const sortedDates = Object.keys(salesByDate).sort((a, b) => new Date(b) - new Date(a));
                                %>
                                
                                <% sortedDates.forEach(date => { 
                                    const data = salesByDate[date];
                                    const netCollection = data.payments - data.refunds;
                                %>
                                    <tr>
                                        <td><strong><%= date %></strong></td>
                                        <td class="text-success fw-bold">₹<%= data.payments.toFixed(2) %></td>
                                        <td class="text-danger fw-bold">₹<%= data.refunds.toFixed(2) %></td>
                                        <td class="text-primary fw-bold">₹<%= netCollection.toFixed(2) %></td>
                                        <td class="text-warning fw-bold">₹<%= data.dues.toFixed(2) %></td>
                                        <td>₹<%= data.cash.toFixed(2) %></td>
                                        <td>₹<%= data.card.toFixed(2) %></td>
                                        <td>₹<%= data.upi.toFixed(2) %></td>
                                        <td>₹<%= data.bank.toFixed(2) %></td>
                                        <td>₹<%= data.others.toFixed(2) %></td>
                                        <td>₹<%= data.cashRefunds.toFixed(2) %></td>
                                        <td>₹<%= data.cardRefunds.toFixed(2) %></td>
                                        <td>₹<%= data.upiRefunds.toFixed(2) %></td>
                                        <td>₹<%= data.bankRefunds.toFixed(2) %></td>
                                        <td>₹<%= data.othersRefunds.toFixed(2) %></td>
                                        <td><span class="badge bg-info"><%= data.transactions %></span></td>
                                    </tr>
                                <% }); %>
                                
                                <% if (sortedDates.length === 0) { %>
                                    <tr>
                                        <td colspan="16" class="text-center text-muted">No data available</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========== TRANSACTIONS TAB ========== -->
        <div class="tab-content-section" id="transactions-tab">
            <!-- Date Filter -->
            <div class="filter-section">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Start Date</label>
                        <input type="date" class="form-control" id="transactionsStartDate" value="<%= filters.startDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">End Date</label>
                        <input type="date" class="form-control" id="transactionsEndDate" value="<%= filters.endDate || '' %>">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Employee</label>
                        <select class="form-select" id="transactionsEmployee">
                            <option value="">All Employees</option>
                            <% if (employees && employees.length > 0) { %>
                                <% employees.forEach(emp => { %>
                                    <option value="<%= emp._id %>" <%= filters.employee === emp._id.toString() ? 'selected' : '' %>>
                                        <%= emp.fullName || emp.username %><% if (emp.role === 'admin') { %> (Admin)<% } %>
                                    </option>
                                <% }); %>
                            <% } %>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Payment Status</label>
                        <select class="form-select" id="transactionsPaymentStatus">
                            <option value="">All Payments</option>
                            <option value="paid" <%= filters.paymentStatus === 'paid' ? 'selected' : '' %>>Paid Only</option>
                            <option value="partial" <%= filters.paymentStatus === 'partial' ? 'selected' : '' %>>Partial Only</option>
                            <option value="due" <%= filters.paymentStatus === 'due' ? 'selected' : '' %>>Due Only</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyTransactionsFilter()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                    <div class="col-md-2">
                        <button class="export-btn w-100" onclick="exportTransactionsCSV()">
                            <i class="bi bi-file-earmark-excel"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions Table -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> All Transactions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="transactionsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Transaction ID</th>
                                    <th>Date & Time</th>
                                    <th>Bill No.</th>
                                    <th>Transaction</th>
                                    <th>Amount</th>
                                    <th>Mode</th>
                                    <th>Booking Status</th>
                                    <th>Payment Status</th>
                                    <th>Booking Details</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                                <% 
                                let hasTransactions = false;
                                
                                // Create array of all transactions with timestamps for sorting
                                let allTransactions = [];
                                
                                sales.forEach(sale => { 
                                    // If sale is cancelled, add refund transaction
                                    if (sale.isCancelled) {
                                        hasTransactions = true;
                                        const txnId = 'TXN-' + sale.billNumber.replace(/Bill-/i, '') + '-R' + (sale.cancelledAt ? new Date(sale.cancelledAt).getTime() : new Date(sale.createdAt).getTime());
                                        allTransactions.push({
                                            txnId: txnId,
                                            date: sale.cancelledAt || sale.createdAt,
                                            timestamp: new Date(sale.cancelledAt || sale.createdAt).getTime(),
                                            billNumber: sale.billNumber,
                                            saleId: sale._id,
                                            type: 'refund',
                                            amount: sale.refundAmount,
                                            method: sale.refundMethod || sale.paymentMethod,
                                            status: 'cancelled',
                                            paymentStatus: 'refund',
                                            total: sale.total,
                                            amountPaid: sale.amountPaid,
                                            refundAmount: sale.refundAmount
                                        });
                                    } else {
                                        // Add payment history transactions if available
                                        if (sale.paymentHistory && sale.paymentHistory.length > 0) {
                                            hasTransactions = true;
                                            sale.paymentHistory.forEach((payment, index) => {
                                                const txnId = 'TXN-' + sale.billNumber.replace(/Bill-/i, '') + '-P' + (index + 1) + '-' + new Date(payment.date).getTime();
                                                allTransactions.push({
                                                    txnId: txnId,
                                                    date: payment.date,
                                                    timestamp: new Date(payment.date).getTime(),
                                                    billNumber: sale.billNumber,
                                                    saleId: sale._id,
                                                    type: 'payment',
                                                    amount: payment.amount,
                                                    method: payment.method,
                                                    status: 'active',
                                                    paymentStatus: sale.paymentStatus,
                                                    total: sale.total,
                                                    amountPaid: sale.amountPaid,
                                                    dueAmount: sale.dueAmount
                                                });
                                            });
                                        } else {
                                            // Add single transaction if no payment history
                                            hasTransactions = true;
                                            const txnId = 'TXN-' + sale.billNumber.replace(/Bill-/i, '') + '-' + new Date(sale.createdAt).getTime();
                                            allTransactions.push({
                                                txnId: txnId,
                                                date: sale.createdAt,
                                                timestamp: new Date(sale.createdAt).getTime(),
                                                billNumber: sale.billNumber,
                                                saleId: sale._id,
                                                type: 'payment',
                                                amount: sale.amountPaid,
                                                method: sale.paymentMethod,
                                                status: 'active',
                                                paymentStatus: sale.paymentStatus,
                                                total: sale.total,
                                                amountPaid: sale.amountPaid,
                                                dueAmount: sale.dueAmount
                                            });
                                        }
                                    }
                                });
                                
                                // Sort transactions by timestamp (newest first)
                                allTransactions.sort((a, b) => b.timestamp - a.timestamp);
                                
                                // Display sorted transactions
                                allTransactions.forEach(txn => {
                                %>
                                    <tr>
                                        <td><strong><%= txn.txnId %></strong></td>
                                        <td><%= new Date(txn.date).toLocaleString() %></td>
                                        <td><a href="/bill/<%= txn.saleId %>" class="text-primary">#<%= txn.billNumber.replace(/Bill-/i, '') %></a></td>
                                        <td>
                                            <% if (txn.type === 'refund') { %>
                                                <span class="badge bg-danger">REFUND</span>
                                            <% } else { %>
                                                <span class="badge bg-success">PAYMENT</span>
                                            <% } %>
                                        </td>
                                        <td class="fw-bold">
                                            <% if (txn.type === 'refund') { %>
                                                <span class="text-danger">₹<%= txn.amount.toFixed(2) %></span>
                                            <% } else { %>
                                                <span class="text-success">₹<%= txn.amount.toFixed(2) %></span>
                                            <% } %>
                                        </td>
                                        <td><%= txn.method.toUpperCase() %></td>
                                        <td>
                                            <% if (txn.status === 'cancelled') { %>
                                                <span class="badge bg-danger">CANCELLED</span>
                                            <% } else { %>
                                                <span class="badge bg-success">ACTIVE</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% if (txn.paymentStatus === 'refund') { %>
                                                <span class="badge bg-danger">PAID: ₹<%= txn.amount.toFixed(2) %></span>
                                            <% } else if (txn.paymentStatus === 'paid') { %>
                                                <span class="badge bg-success">PAID: ₹<%= txn.amountPaid.toFixed(2) %></span>
                                            <% } else if (txn.paymentStatus === 'partial') { %>
                                                <span class="badge bg-warning">PARTIAL: ₹<%= txn.amountPaid.toFixed(2) %></span>
                                            <% } else { %>
                                                <span class="badge bg-secondary">DUE</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <div><strong>Total:</strong> ₹<%= txn.total.toFixed(2) %></div>
                                            <% if (txn.type === 'refund') { %>
                                                <div class="text-danger"><strong>Refunded:</strong> ₹<%= txn.refundAmount.toFixed(2) %></div>
                                            <% } else { %>
                                                <div class="text-success"><strong>Paid:</strong> ₹<%= txn.amountPaid.toFixed(2) %></div>
                                                <% if (txn.dueAmount > 0) { %>
                                                    <div class="text-danger"><strong>Due:</strong> ₹<%= txn.dueAmount.toFixed(2) %></div>
                                                <% } %>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                                
                                <% if (!hasTransactions) { %>
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">No transactions available</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.report-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content-section').forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                const tabName = this.getAttribute('data-tab');
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Filter functions
        function applySummaryFilter() {
            const startDate = document.getElementById('summaryStartDate').value;
            const endDate = document.getElementById('summaryEndDate').value;
            const employee = document.getElementById('summaryEmployee').value;
            const paymentStatus = document.getElementById('summaryPaymentStatus').value;
            let url = '/reports?tab=summary';
            if (startDate) url += '&startDate=' + startDate;
            if (endDate) url += '&endDate=' + endDate;
            if (employee) url += '&employee=' + employee;
            if (paymentStatus) url += '&paymentStatus=' + paymentStatus;
            window.location.href = url;
        }

        function applyTrendsFilter() {
            const startDate = document.getElementById('trendsStartDate').value;
            const endDate = document.getElementById('trendsEndDate').value;
            const employee = document.getElementById('trendsEmployee').value;
            const paymentStatus = document.getElementById('trendsPaymentStatus').value;
            let url = '/reports?tab=trends';
            if (startDate) url += '&startDate=' + startDate;
            if (endDate) url += '&endDate=' + endDate;
            if (employee) url += '&employee=' + employee;
            if (paymentStatus) url += '&paymentStatus=' + paymentStatus;
            window.location.href = url;
        }

        function applyTransactionsFilter() {
            const startDate = document.getElementById('transactionsStartDate').value;
            const endDate = document.getElementById('transactionsEndDate').value;
            const employee = document.getElementById('transactionsEmployee').value;
            const paymentStatus = document.getElementById('transactionsPaymentStatus').value;
            let url = '/reports?tab=transactions';
            if (startDate) url += '&startDate=' + startDate;
            if (endDate) url += '&endDate=' + endDate;
            if (employee) url += '&employee=' + employee;
            if (paymentStatus) url += '&paymentStatus=' + paymentStatus;
            window.location.href = url;
        }

        // Export functions
        function exportSummaryCSV() {
            exportCSV('summary');
        }

        function exportTrendsCSV() {
            exportCSV('trends');
        }

        function exportTransactionsCSV() {
            exportCSV('transactions');
        }

        function exportCSV(type) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('export', type);
            
            const exportBtn = event.target.closest('button');
            const originalHTML = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exporting...';
            
            fetch('/reports/export-csv?' + urlParams.toString())
                .then(response => {
                    if (!response.ok) throw new Error('Export failed');
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'Bireena_' + type + '_' + new Date().toISOString().split('T')[0] + '.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalHTML;
                })
                .catch(error => {
                    alert('Failed to export CSV');
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalHTML;
                });
        }

        // Sales Search functionality
        const salesSearch = document.getElementById('salesSearch');
        if (salesSearch) {
            salesSearch.addEventListener('keyup', function() {
                const searchValue = this.value.toLowerCase();
                const tableBody = document.getElementById('salesTableBody');
                if (!tableBody) return;
                
                const rows = tableBody.getElementsByTagName('tr');
                let visibleCount = 0;

                for (let i = 0; i < rows.length; i++) {
                    const billCell = rows[i].getElementsByTagName('td')[0];
                    if (billCell) {
                        const billText = billCell.textContent || billCell.innerText;
                        if (billText.toLowerCase().indexOf(searchValue) > -1) {
                            rows[i].style.display = '';
                            visibleCount++;
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            });
        }

        // Restore active tab from URL
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab') || 'summary';
        if (activeTab !== 'summary') {
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content-section').forEach(s => s.classList.remove('active'));
            document.querySelector('[data-tab="' + activeTab + '"]').classList.add('active');
            document.getElementById(activeTab + '-tab').classList.add('active');
        }
    </script>
</body>
</html>
