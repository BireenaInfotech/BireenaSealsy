<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill - <%= sale.billNumber %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Responsive Bill Styles */
        .totals-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .totals-table {
            margin-bottom: 0 !important;
        }
        
        .totals-table td {
            white-space: nowrap;
        }
        
        /* Responsive utility classes */
        @media (min-width: 768px) {
            .w-md-auto {
                width: auto !important;
            }
        }
        
        @media (max-width: 768px) {
            .card-header h4 {
                font-size: 1.1rem;
            }
            .card-header .btn {
                font-size: 0.8rem;
                padding: 0.25rem 0.5rem;
            }
            .table {
                font-size: 0.85rem;
            }
            .table td, .table th {
                padding: 0.5rem 0.25rem;
            }
            
            /* Items table responsive */
            .table-bordered th {
                font-size: 0.8rem;
                padding: 0.5rem 0.3rem;
            }
            
            .table-bordered td {
                font-size: 0.85rem;
                padding: 0.5rem 0.3rem;
            }
            
            .table-bordered small {
                font-size: 0.7rem;
            }
            
            /* Totals section responsive */
            .totals-table td {
                padding: 0.6rem 0.5rem !important;
                font-size: 0.9rem;
            }
            
            .totals-table h5 {
                font-size: 1.1rem !important;
                margin-bottom: 0 !important;
            }
            
            .totals-table strong {
                font-size: 0.9rem;
            }
            
            .payment-status {
                font-size: 0.85rem !important;
            }
            
            .btn-group-mobile {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .btn-group-mobile .btn {
                width: 100%;
            }
            .modal-lg {
                max-width: 95%;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 0.5rem;
            }
            .card-body {
                padding: 1rem 0.5rem;
            }
            h5 {
                font-size: 1rem;
            }
            .table-responsive {
                font-size: 0.75rem;
            }
            
            /* Items table - Extra small screens */
            .table-bordered {
                font-size: 0.75rem !important;
            }
            
            .table-bordered th {
                font-size: 0.7rem;
                padding: 0.4rem 0.2rem;
                white-space: nowrap;
            }
            
            .table-bordered td {
                font-size: 0.75rem;
                padding: 0.4rem 0.2rem;
            }
            
            .table-bordered td:first-child {
                /* # column */
                width: 30px;
            }
            
            .table-bordered small {
                font-size: 0.65rem;
                line-height: 1.2;
            }
            
            /* Card headers on mobile */
            .card-header h5 {
                font-size: 0.95rem;
            }
            
            .alert h4 {
                font-size: 1rem;
            }
            
            /* Buttons on mobile */
            .btn-lg {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
            
            /* Extra small screens - Totals section */
            .totals-table td {
                padding: 0.5rem 0.3rem !important;
                font-size: 0.85rem;
            }
            
            .totals-table h5 {
                font-size: 1rem !important;
            }
            
            .totals-table strong {
                font-size: 0.85rem;
            }
            
            .payment-status {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.5rem;
            }
            
            .totals-table .badge {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
            
            /* Customer and shop info */
            .info-section p {
                font-size: 0.85rem;
                margin-bottom: 0.3rem;
            }
            
            .info-section small {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <% if (typeof success_msg !== 'undefined' && success_msg.length > 0) { %>
        <div class="alert alert-success alert-dismissible fade show m-3">
            <%= success_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <% if (typeof error_msg !== 'undefined' && error_msg.length > 0) { %>
        <div class="alert alert-danger alert-dismissible fade show m-3">
            <%= error_msg %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <% } %>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="bi bi-receipt"></i> Bill Details</h4>
                        <div>
                            <% if (sale.customerPhone) { %>
                                <form action="/bill/resend-sms/<%= sale._id %>" method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-success btn-sm">
                                        <i class="bi bi-envelope"></i> SEND SMS
                                    </button>
                                </form>
                            <% } %>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-sm-6 mb-3 mb-sm-0">
                                <h5><%= shopInfo.shopName %></h5>
                                <% if (shopInfo.shopAddress && shopInfo.shopAddress.trim() !== '') { %>
                                    <p class="mb-1"><%= shopInfo.shopAddress %></p>
                                <% } %>
                                <% if (shopInfo.shopGST && shopInfo.shopGST.trim() !== '') { %>
                                    <p class="mb-0"><strong>GST:</strong> <%= shopInfo.shopGST %></p>
                                <% } %>
                            </div>
                            <div class="col-sm-6 text-sm-end">
                                <h5>Bill #<%= sale.billNumber %></h5>
                                <p class="mb-0"><%= new Date(sale.createdAt).toLocaleString() %></p>
                            </div>
                        </div>

                        <!-- Cancellation Alert -->
                        <% if (sale.isCancelled) { %>
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading"><i class="bi bi-x-octagon"></i> Sale Cancelled</h4>
                                <p><strong>Cancelled At:</strong> <%= new Date(sale.cancelledAt).toLocaleString() %></p>
                                <% if (sale.cancelledBy) { %>
                                    <p><strong>Cancelled By:</strong> <%= sale.cancelledBy.fullName || sale.cancelledBy.username %></p>
                                <% } %>
                                <p><strong>Reason:</strong> <%= sale.cancellationReason %></p>
                                <hr>
                                <p class="mb-0"><strong>Refund Amount:</strong> <span class="text-danger">₹<%= sale.refundAmount.toFixed(2) %></span></p>
                                <p class="mb-0"><strong>Refund Method:</strong> <%= sale.refundMethod.toUpperCase() %></p>
                                <% if (sale.refundNotes) { %>
                                    <p class="mb-0"><strong>Notes:</strong> <%= sale.refundNotes %></p>
                                <% } %>
                            </div>
                        <% } %>

                        <div class="row mb-4">
                            <div class="col-sm-6 mb-3 mb-sm-0">
                                <strong>Customer Details:</strong><br>
                                <%= sale.customerName && sale.customerName.trim() !== '' ? sale.customerName : 'N/A' %><br>
                                <% if (sale.customerPhone) { %>
                                    <%= sale.customerPhone %><br>
                                <% } %>
                                <% if (sale.customerType === 'B2B') { %>
                                    <span class="badge bg-info mt-1">B2B Customer</span><br>
                                <% } %>
                                <% if (sale.customerGSTIN && sale.customerGSTIN.trim() !== '') { %>
                                    <small><strong>GSTIN:</strong> <%= sale.customerGSTIN %></small><br>
                                <% } %>
                                <% if (sale.placeOfSupply && sale.placeOfSupply.trim() !== '') { %>
                                    <small><strong>Place of Supply:</strong> <%= sale.placeOfSupply %></small>
                                <% } %>
                            </div>
                            <div class="col-sm-6 text-sm-end">
                                <strong>Payment Method:</strong><br>
                                <span class="badge bg-secondary"><%= sale.paymentMethod.toUpperCase() %></span><br>
                                <% if (sale.smsSent) { %>
                                    <span class="badge bg-success mt-2">
                                        <i class="bi bi-check-circle"></i> SMS Sent
                                    </span>
                                <% } %>
                                <% if (sale.isCancelled) { %>
                                    <br><span class="badge bg-danger mt-2">
                                        <i class="bi bi-x-circle"></i> Cancelled
                                    </span>
                                <% } %>
                            </div>
                        </div>

                        <div class="table-responsive mb-4">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Item</th>
                                        <% if (sale.customerType === 'B2B') { %>
                                        <th>HSN</th>
                                        <% } %>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% sale.items.forEach((item, index) => { 
                                        const itemDiscount = item.itemDiscount || 0;
                                    %>
                                        <tr>
                                            <td><%= index + 1 %></td>
                                            <td>
                                                <%= item.productName %>
                                                <% if (itemDiscount > 0) { %>
                                                    <br><small class="text-success">Item Discount: -₹<%= itemDiscount.toFixed(2) %></small>
                                                <% } %>
                                                <% if (sale.customerType === 'B2B' && (item.cgstAmount > 0 || item.igstAmount > 0)) { %>
                                                    <br><small class="text-muted">
                                                        <% if (item.igstAmount > 0) { %>
                                                            IGST <%= item.igstRate %>%: ₹<%= item.igstAmount.toFixed(2) %>
                                                        <% } else { %>
                                                            CGST <%= item.cgstRate %>%: ₹<%= item.cgstAmount.toFixed(2) %> | SGST <%= item.sgstRate %>%: ₹<%= item.sgstAmount.toFixed(2) %>
                                                        <% } %>
                                                    </small>
                                                <% } %>
                                            </td>
                                            <% if (sale.customerType === 'B2B') { %>
                                            <td><small><%= item.hsnCode || 'N/A' %></small></td>
                                            <% } %>
                                            <td>₹<%= item.price.toFixed(2) %></td>
                                            <td><%= item.quantity %></td>
                                            <td class="text-end">₹<%= item.subtotal.toFixed(2) %></td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>

                        <div class="row">
                            <div class="col-lg-6 d-none d-lg-block"></div>
                            <div class="col-12 col-lg-6">
                                <div class="totals-table-wrapper">
                                    <table class="table totals-table">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td class="text-end">₹<%= sale.subtotal.toFixed(2) %></td>
                                        </tr>
                                    <% if (sale.discount > 0) { %>
                                        <tr>
                                            <td><strong>Discount:</strong></td>
                                            <td class="text-end text-danger">-₹<%= sale.discount.toFixed(2) %></td>
                                        </tr>
                                    <% } %>
                                    <% if (sale.totalGST && sale.totalGST > 0) { %>
                                        <% if (sale.isInterState) { %>
                                        <tr class="table-info">
                                            <td><strong>IGST:</strong></td>
                                            <td class="text-end">₹<%= sale.totalIGST.toFixed(2) %></td>
                                        </tr>
                                        <% } else { %>
                                        <tr class="table-info">
                                            <td><strong>CGST:</strong></td>
                                            <td class="text-end">₹<%= sale.totalCGST.toFixed(2) %></td>
                                        </tr>
                                        <tr class="table-info">
                                            <td><strong>SGST:</strong></td>
                                            <td class="text-end">₹<%= sale.totalSGST.toFixed(2) %></td>
                                        </tr>
                                        <% } %>
                                    <% } %>
                                    <tr class="table-light">
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end"><h5 class="mb-0">₹<%= sale.total.toFixed(2) %></h5></td>
                                    </tr>
                                    <tr class="table-success">
                                        <td><strong>Amount Paid:</strong></td>
                                        <td class="text-end"><h5 class="mb-0 text-success">₹<%= sale.amountPaid.toFixed(2) %></h5></td>
                                    </tr>
                                    <% if (sale.dueAmount > 0) { %>
                                        <tr class="table-danger">
                                            <td><strong>Due Amount:</strong></td>
                                            <td class="text-end"><h5 class="mb-0 text-danger">₹<%= sale.dueAmount.toFixed(2) %></h5></td>
                                        </tr>
                                    <% } %>
                                        <tr>
                                            <td><strong>Payment Status:</strong></td>
                                            <td class="text-end">
                                                <span class="payment-status badge <%= sale.paymentStatus === 'paid' ? 'bg-success' : (sale.paymentStatus === 'partial' ? 'bg-warning text-dark' : 'bg-danger') %>">
                                                    <% if (sale.paymentStatus === 'paid') { %>
                                                        <i class="bi bi-check-circle"></i> Fully Paid
                                                    <% } else if (sale.paymentStatus === 'partial') { %>
                                                        <i class="bi bi-exclamation-circle"></i> Partially Paid
                                                    <% } else { %>
                                                        <i class="bi bi-x-circle"></i> Payment Due
                                                    <% } %>
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Cancel Sale Button and Add Item Button -->
                        <% if (!sale.isCancelled) { %>
                            <div class="mt-4 d-flex flex-column flex-sm-row justify-content-between align-items-stretch align-items-sm-center gap-2">
                                <a href="/sales/cancel/<%= sale._id %>" class="btn btn-danger">
                                    <i class="bi bi-x-octagon"></i> Cancel Sale & Refund
                                </a>
                                <% 
                                    const currentTime = new Date();
                                    const saleTime = new Date(sale.createdAt);
                                    const timeDifferenceMinutes = (currentTime - saleTime) / (1000 * 60);
                                    const canAddItems = timeDifferenceMinutes <= 15;
                                %>
                                <% if (canAddItems) { %>
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                        <i class="bi bi-plus-circle"></i> Add Item
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-secondary" disabled title="Can only add items within 15 minutes of sale">
                                        <i class="bi bi-plus-circle"></i> Add Item (Expired)
                                    </button>
                                <% } %>
                            </div>
                        <% } %>

                        <!-- Clear Due Payment Section -->
                        <% if (sale.dueAmount > 0 && !sale.isCancelled) { %>
                            <div class="card mt-4 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Clear Due Payment</h5>
                                </div>
                                <div class="card-body">
                                    <form action="/sales/clear-due/<%= sale._id %>" method="POST">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Payment Amount <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" name="paymentAmount" 
                                                       step="0.01" min="0.01" max="<%= sale.dueAmount %>" 
                                                       value="<%= sale.dueAmount %>" required>
                                                <small class="text-muted">Maximum: ₹<%= sale.dueAmount.toFixed(2) %></small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                                                <select class="form-select" name="paymentMethod" required>
                                                    <option value="cash">Cash</option>
                                                    <option value="card">Card</option>
                                                    <option value="upi">UPI</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-success btn-lg w-100 w-md-auto">
                                                <i class="bi bi-check-circle"></i> Receive Payment
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        <% } %>

                        <!-- Payment History -->
                        <% if (sale.paymentHistory && sale.paymentHistory.length > 0) { %>
                            <div class="card mt-4">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Payment History</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Date & Time</th>
                                                    <th>Amount</th>
                                                    <th>Method</th>
                                                    <th>Received By</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% sale.paymentHistory.forEach(payment => { %>
                                                    <tr>
                                                        <td><%= formatForBill(payment.date) %></td>
                                                        <td class="text-success fw-bold">₹<%= payment.amount.toFixed(2) %></td>
                                                        <td><span class="badge bg-secondary"><%= payment.method.toUpperCase() %></span></td>
                                                        <td>
                                                            <% if (payment.receivedBy) { %>
                                                                <%= payment.receivedBy.fullName || payment.receivedBy.username %>
                                                            <% } else { %>
                                                                N/A
                                                            <% } %>
                                                        </td>
                                                    </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        <% } %>

                        <div class="text-center mt-4">
                            <a href="/sales" class="btn btn-secondary w-100 w-md-auto">
                                <i class="bi bi-arrow-left"></i> Back to Sales
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addItemModalLabel">
                        <i class="bi bi-plus-circle"></i> Add Items to Bill #<%= sale.billNumber %>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="/sales/add-items/<%= sale._id %>" method="POST" id="addItemForm">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> You can add items within 15 minutes of creating the sale.
                        </div>
                        
                        <div id="loadingProducts" class="text-center py-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading products...</p>
                        </div>
                        
                        <div id="itemsList">
                            <!-- Item rows will be added here -->
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItemRow()">
                            <i class="bi bi-plus"></i> Add Another Item
                        </button>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Payment Method</label>
                                <select class="form-select" name="paymentMethod" required>
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="online">Online</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Amount Received</label>
                                <input type="number" 
                                       class="form-control" 
                                       name="amountReceived" 
                                       id="amountReceived"
                                       min="0" 
                                       step="0.01" 
                                       value="0"
                                       placeholder="Enter amount received (0 for full due)"
                                       oninput="updatePaymentSummary()">
                                <small class="text-muted">Enter 0 if no payment received (full amount will be added to dues)</small>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <% if (sale.dueAmount > 0) { %>
                                <div class="alert alert-warning mb-3" style="background-color: rgba(255, 193, 7, 0.2); border: 1px solid rgba(255, 193, 7, 0.5); color: #ffc107;">
                                    <i class="bi bi-exclamation-triangle-fill"></i> <strong>Previous Due: ₹<%= sale.dueAmount.toFixed(2) %></strong>
                                </div>
                            <% } %>
                            <div class="row">
                                <div class="col-6">
                                    <h6 class="mb-1">New Items Total:</h6>
                                    <h4 class="mb-0" id="modalTotal">₹0.00</h4>
                                </div>
                                <div class="col-6">
                                    <h6 class="mb-1">Amount Received:</h6>
                                    <h4 class="mb-0" id="displayAmountReceived">₹0.00</h4>
                                </div>
                            </div>
                            <hr class="my-2" style="border-color: rgba(255,255,255,0.3);">
                            <div class="row">
                                <div class="col-6">
                                    <small>New Due Amount:</small>
                                    <h5 class="mb-0" id="displayDueAmount" style="color: #ffd700;">₹0.00</h5>
                                </div>
                                <div class="col-6">
                                    <small>Payment Status:</small>
                                    <h5 class="mb-0">
                                        <span id="displayPaymentStatus" class="badge bg-light text-dark">Pending</span>
                                    </h5>
                                </div>
                            </div>
                            <% if (sale.dueAmount > 0) { %>
                                <hr class="my-2" style="border-color: rgba(255,255,255,0.3);">
                                <div class="text-center">
                                    <small>Total Due After Adding Items:</small>
                                    <h4 class="mb-0" id="totalDueAfterAdding" style="color: #ff6b6b;">₹<%= sale.dueAmount.toFixed(2) %></h4>
                                </div>
                            <% } %>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Add Items & Update Bill
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</div>
<!-- End Main Content Wrapper -->

    <script>
        let itemCount = 0;
        let availableProducts = [];
        
        // Fetch available products
        async function fetchProducts() {
            const loadingDiv = document.getElementById('loadingProducts');
            const itemsList = document.getElementById('itemsList');
            
            try {
                // Show loading
                if (loadingDiv) loadingDiv.style.display = 'block';
                
                const response = await fetch('/sales/api/products', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide loading
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                if (data.success && data.products && Array.isArray(data.products)) {
                    availableProducts = data.products;
                    
                    if (availableProducts.length === 0) {
                        if (itemsList) {
                            itemsList.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> No products available in inventory. Please add products with stock first.</div>';
                        }
                    } else {
                        addItemRow(); // Add first row
                    }
                } else {
                    throw new Error(data.message || 'Invalid response format');
                }
            } catch (error) {
                if (loadingDiv) loadingDiv.style.display = 'none';
                if (itemsList) {
                    itemsList.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Error loading products. Please refresh the page.</div>';
                }
            }
        }
        
        // Add item row
        function addItemRow() {
            const itemsList = document.getElementById('itemsList');
            
            if (!availableProducts || availableProducts.length === 0) {
                if (itemsList && !itemsList.querySelector('.alert')) {
                    itemsList.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> No products available. Please add products to inventory first.</div>';
                }
                return;
            }
            
            itemCount++;
            const itemRow = document.createElement('div');
            itemRow.className = 'row mb-3 item-row align-items-end';
            itemRow.id = `item-${itemCount}`;
            
            const uniqueId = `product-search-${itemCount}`;
            
            itemRow.innerHTML = `
                <div class="col-12 col-md-5 mb-2 mb-md-0">
                    <label class="form-label">Product (Type to search)</label>
                    <div class="position-relative">
                        <input type="text" 
                               class="form-control product-search-input" 
                               id="${uniqueId}" 
                               placeholder="Search product by name..."
                               autocomplete="off"
                               oninput="searchProducts(${itemCount})"
                               onfocus="showProductDropdown(${itemCount})"
                               data-row="${itemCount}">
                        <input type="hidden" 
                               class="product-id-input" 
                               name="items[${itemCount}][productId]" 
                               id="product-id-${itemCount}"
                               required>
                        <div class="product-dropdown" 
                             id="dropdown-${itemCount}" 
                             style="display:none; position:absolute; z-index:1000; width:100%; max-height:300px; overflow-y:auto; background:white; border:1px solid #ddd; border-radius:4px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control quantity-input" name="items[${itemCount}][quantity]" min="1" value="1" onchange="calculateRowTotal(${itemCount})" required>
                </div>
                <div class="col-6 col-md-3 mb-2 mb-md-0">
                    <label class="form-label">Subtotal</label>
                    <input type="text" class="form-control subtotal-display" id="subtotal-${itemCount}" readonly value="₹0.00">
                </div>
                <div class="col-12 col-md-2">
                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeItemRow(${itemCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            if (itemsList) {
                // Remove any alert messages when adding a row
                const alerts = itemsList.querySelectorAll('.alert');
                alerts.forEach(alert => alert.remove());
                itemsList.appendChild(itemRow);
            }
        }
        
        // Search products function
        function searchProducts(rowId) {
            const searchInput = document.getElementById(`product-search-${rowId}`);
            const dropdown = document.getElementById(`dropdown-${rowId}`);
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm.length === 0) {
                // Show all products if search is empty
                showAllProducts(rowId);
                return;
            }
            
            // Filter products based on search
            const filteredProducts = availableProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
            );
            
            displayProductDropdown(rowId, filteredProducts);
        }
        
        // Show all products in dropdown
        function showAllProducts(rowId) {
            displayProductDropdown(rowId, availableProducts);
        }
        
        // Show product dropdown
        function showProductDropdown(rowId) {
            showAllProducts(rowId);
        }
        
        // Display products in dropdown
        function displayProductDropdown(rowId, products) {
            const dropdown = document.getElementById(`dropdown-${rowId}`);
            
            if (!products || products.length === 0) {
                dropdown.innerHTML = '<div class="p-2 text-muted">No products found</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            let html = '';
            products.forEach(p => {
                const price = parseFloat(p.price) || 0;
                const stock = parseInt(p.stock) || 0;
                html += `
                    <div class="product-item p-2" 
                         style="cursor:pointer; border-bottom:1px solid #eee;"
                         onmouseover="this.style.backgroundColor='#f0f0f0'"
                         onmouseout="this.style.backgroundColor='white'"
                         onclick="selectProduct(${rowId}, '${p._id}', '${p.name.replace(/'/g, "\\'")}', ${price}, ${stock})">
                        <div style="font-weight:500;">${p.name}</div>
                        <div style="font-size:0.85rem; color:#666;">
                            <span>₹${price.toFixed(2)}</span> | 
                            <span style="color:${stock > 10 ? 'green' : stock > 0 ? 'orange' : 'red'}">Stock: ${stock}</span>
                        </div>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }
        
        // Select product from dropdown
        function selectProduct(rowId, productId, productName, price, stock) {
            // Set the search input to show selected product name
            const searchInput = document.getElementById(`product-search-${rowId}`);
            searchInput.value = productName;
            
            // Set the hidden product ID
            const productIdInput = document.getElementById(`product-id-${rowId}`);
            productIdInput.value = productId;
            productIdInput.dataset.price = price;
            productIdInput.dataset.stock = stock;
            
            // Hide dropdown
            const dropdown = document.getElementById(`dropdown-${rowId}`);
            dropdown.style.display = 'none';
            
            // Calculate total
            calculateRowTotal(rowId);
        }
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.product-search-input') && !e.target.closest('.product-dropdown')) {
                document.querySelectorAll('.product-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Calculate row total
        function calculateRowTotal(rowId) {
            const row = document.getElementById(`item-${rowId}`);
            const productIdInput = document.getElementById(`product-id-${rowId}`);
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;
            
            if (productIdInput && productIdInput.value && quantity > 0) {
                const price = parseFloat(productIdInput.dataset.price) || 0;
                const stock = parseInt(productIdInput.dataset.stock) || 0;
                
                if (quantity > stock) {
                    alert(`Only ${stock} items available in stock`);
                    row.querySelector('.quantity-input').value = stock;
                    return;
                }
                
                const subtotal = price * quantity;
                row.querySelector('.subtotal-display').value = `₹${subtotal.toFixed(2)}`;
            } else {
                row.querySelector('.subtotal-display').value = '₹0.00';
            }
            
            calculateModalTotal();
        }
        
        // Calculate modal total
        function calculateModalTotal() {
            let total = 0;
            document.querySelectorAll('.subtotal-display').forEach(input => {
                const value = input.value.replace('₹', '').replace(',', '');
                total += parseFloat(value) || 0;
            });
            document.getElementById('modalTotal').textContent = `₹${total.toFixed(2)}`;
            
            // Update payment summary
            updatePaymentSummary();
        }
        
        // Update payment summary
        function updatePaymentSummary() {
            const totalText = document.getElementById('modalTotal').textContent;
            const total = parseFloat(totalText.replace('₹', '').replace(',', '')) || 0;
            
            const amountReceivedInput = document.getElementById('amountReceived');
            const amountReceived = parseFloat(amountReceivedInput?.value) || 0;
            
            // Update displayed values
            document.getElementById('displayAmountReceived').textContent = `₹${amountReceived.toFixed(2)}`;
            
            const dueAmount = Math.max(0, total - amountReceived);
            document.getElementById('displayDueAmount').textContent = `₹${dueAmount.toFixed(2)}`;
            
            // Update payment status
            const statusElement = document.getElementById('displayPaymentStatus');
            if (amountReceived === 0) {
                statusElement.textContent = 'Due';
                statusElement.className = 'badge bg-danger';
            } else if (amountReceived >= total) {
                statusElement.textContent = 'Fully Paid';
                statusElement.className = 'badge bg-success';
            } else {
                statusElement.textContent = 'Partial';
                statusElement.className = 'badge bg-warning text-dark';
            }
            
            // Set max value for amount received
            if (amountReceivedInput && total > 0) {
                amountReceivedInput.max = total;
            }
            
            // Update total due after adding items (if previous due exists)
            const totalDueElement = document.getElementById('totalDueAfterAdding');
            if (totalDueElement) {
                const previousDue = <%= sale.dueAmount %>;
                const totalDueAfterAdding = previousDue + dueAmount;
                totalDueElement.textContent = `₹${totalDueAfterAdding.toFixed(2)}`;
            }
        }
        
        // Remove item row
        function removeItemRow(rowId) {
            const row = document.getElementById(`item-${rowId}`);
            if (row) {
                row.remove();
                calculateModalTotal();
            }
        }
        
        // Load products when modal is opened
        const addItemModal = document.getElementById('addItemModal');
        if (addItemModal) {
            addItemModal.addEventListener('show.bs.modal', function() {
                // Clear existing items
                document.getElementById('itemsList').innerHTML = '';
                itemCount = 0;
                
                // Reset payment fields
                const amountReceivedInput = document.getElementById('amountReceived');
                if (amountReceivedInput) {
                    amountReceivedInput.value = '';
                }
                
                // Reset totals
                document.getElementById('modalTotal').textContent = '₹0.00';
                updatePaymentSummary();
                
                // Load products
                if (availableProducts.length === 0) {
                    fetchProducts();
                } else {
                    addItemRow(); // Add first row if products already loaded
                }
            });
        }
        
        // Form submission validation
        document.getElementById('addItemForm')?.addEventListener('submit', function(e) {
            const rows = document.querySelectorAll('.item-row');
            if (rows.length === 0) {
                e.preventDefault();
                alert('Please add at least one item');
                return false;
            }
            
            let hasValidItem = false;
            let missingProducts = [];
            
            rows.forEach((row, index) => {
                const productIdInput = row.querySelector('.product-id-input');
                if (productIdInput && productIdInput.value) {
                    hasValidItem = true;
                } else {
                    missingProducts.push(index + 1);
                }
            });
            
            if (!hasValidItem) {
                e.preventDefault();
                alert('Please select at least one product');
                return false;
            }
            
            if (missingProducts.length > 0) {
                e.preventDefault();
                alert('Please select a product for row(s): ' + missingProducts.join(', '));
                return false;
            }
        });
    </script>
</body>
</html>
